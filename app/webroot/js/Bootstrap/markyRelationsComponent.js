var originElement=null,pos={},lastInterRelationId=-1,colour,directed=!1,marker="",relationText="",relationName,actualLine="",timeshort=200,timeLong=1e3,timeExtraLong=1e4,InterRelationAttr="data-annotation-relation-ids-json",relationAttr="data-relation-id",relationId,relationClass="hasRelation",relationJsonClass="hasRelationJson",showRelationClass="showRelation",wrapped=!1,borderType=0,lastColor="",actualColor="",relationsMap=[],removeInterRelationTimeOut,lastRelationScrolled,parent="body",responsive=!1,openRelationBar=!1,inRelationMode=!1,relationsMap={},popoverTemplate="",datatable=null,showAllRelationsOption=!1,defaultRelation=null;$(document).ready(function(){interRelationsMap=JSON.parse($("#interRelationsMap").val()),0==interRelationsMap.length&&(interRelationsMap={}),popoverTemplate=$("#interRelationPopover").html(),0<$("#relationsMap").length&&(relationsMap=JSON.parse($("#relationsMap").val())),$.fn.getRealDimensions=function(a){var b=$(this);if(0==b.length)return!1;var c=b.clone().show().css("visibility","hidden").appendTo("body"),d={width:a?c.outerWidth():c.innerWidth(),height:a?c.outerHeight():c.innerHeight(),offsetTop:c.offset().top,offsetLeft:c.offset().left};return c.remove(),d},$("#viewRelationsTable").click(function(){showRelationsBar()}),$("#viewRelations").click(function(){$(this).hasClass("active")?($(this).removeClass("active"),showAllRelationsOption=!1,clearInterRelations(!0)):($(this).addClass("active"),showAllRelationsOption=!0,showAllRelations())}),$("#hideRelationsBar").click(function(){hideRelationsBar()}),createRelationsDatatable(),$("body").on("click","button.popover-remove-relation",function(){var a=$(this).data("aId"),b=$(this).data("bId"),c=$(this).data("interRelationId");if(null==c||-1==c)return errorDialog("inter relation id  not found");var d=null,f=null,g=0,k=0,l=0,m=0,n=[];$("#myModal").modal(),$.ajax({type:"POST",url:markyLoctaion+"annotationsInterRelations/deleteSelected/",data:{"selected-items":"["+c+"]"}}).done(function(o){if(o.success){if(a in interRelationsMap){var p=interRelationsMap[a],q=[],r=-1;$(".pulsar").removeClass("pulsar"),$(textContent+" "+annotationTag+"."+relationClass).each(function(){var s=$(this).attr(parseAnnotationIdAttr);s==a?(r=$(this).closest(textContent).attr("id"),q[r]=r,d=$(this)):s==b&&(r=$(this).closest(textContent).attr("id"),q[r]=r,f=$(this))})}if(null==d||null==f)errorDialog("Dom annotations not found");else if(removeInterRelationOfMapAndDom(d,f,c),isMultidocument){for(g in clearTexts(),refreshRelations(q),q)k=$("#"+g),l=k.attr("data-document-id"),m=k.attr("data-users-round-id"),n[g]={text_marked:k.html(),document_id:l,id:g,users_round_id:m};multisaveDocuments(n,function(){$("#myModal").modal("hide"),clearInterRelations()})}}else errorDialog(o.message)})}),$("#relationsContainer").on("click",".interRelationNode",function(){clearInterRelations(!0);var a=$(this).attr("data-annotation-A"),b=$(this).attr("data-annotation-B"),c=$(this).attr("data-relation-id"),d=$(annotationTag+"["+parseAnnotationIdAttr+"="+a+"]"),f=$(annotationTag+"["+parseAnnotationIdAttr+"="+b+"]"),g=$("div.textContent[data-document-id='"+$(this).attr("data-document-id")+"']");if(0<g.length){var k=g.offset().top+$("#content").scrollTop();$("#content").animate({scrollTop:k-250})}if($(".interRelationNode.active").removeClass("active"),$(this).addClass("active"),$("mark.pulsar").removeClass("pulsar"),a in interRelationsMap&&b in interRelationsMap[a]&&c in interRelationsMap[a][b]){var l=interRelationsMap[a][b][c],m=l.directedTo;colour=relationsMap[c].colour,directed=relationsMap[c].is_directed,marker=relationsMap[c].marker,relationText=relationsMap[c].name,lastInterRelationId=l.interRelationId,lastColor===colour&&borderType++,lastColor=colour,m==b?createDomRelation(d,f,!0):createDomRelation(f,d,!0)}}),$("body").on("change","input.relation-selector",function(){var b=$(this).closest(".widget"),d=$(this);d.is(":checked")?(b.find("input:checkbox").prop("checked",!1),d.prop("checked",!0)):d.prop("checked",!1),d.is(":checked")?(defaultRelation=d,disableAnnotations=!0):(defaultRelation=null,disableAnnotations=!1)})});function createRelationsDatatable(){datatable=$("#interRelationsTable").dataTable({paging:!1,scrollY:"600px",scrollCollapse:!0,responsive:!0,fixedColumns:!0,dom:" <\"search\"f><\"top\"l>rt<\"bottom\"ip><\"clear\">"})}function flicker(a,b,c){c=c||0,$("."+actualLine)[0==c%2?"hide":"show"](),setTimeout(function(){return 2*a<=c?void b():void flicker(a,b,c+1)},timeshort)}var anyMatchInArray=function(a,b){"use strict";var c,d,f,g,k;for(c=!1,d={},(f=0,g=a.length);f<g;f++)k=a[f],d[k]=!0;for(f=0,g=b.length;!c&&f<g;f++)k=b[f],c=!!d[k];return c};function isInterRelationRepated(a,b){if(a.hasAttr(InterRelationAttr)&&b.hasAttr(InterRelationAttr)){var c=JSON.parse(a.attr(InterRelationAttr)),d=JSON.parse(b.attr(InterRelationAttr));return anyMatchInArray(c,d)}return!1}function newReelation(a,b){endLinkMode(),isInterRelationRepated(a,b)?errorDialog("Two annotations can not have two different relationships between them"):$.ajax({type:"POST",url:markyLoctaion+"annotationsInterRelations/add/",data:{annotation_a_id:a.attr("data-id"),annotation_b_id:b.attr("data-id"),relation_id:relationId}}).done(function(c){if(c.success){addInterRelationId(a,b,relationId,c.id),clearTexts();var d=$(a).closest(textContent),f=d.attr("data-document-id"),g=d.attr("data-users-round-id"),k=d.attr("id"),l=[];l[k]={text_marked:d.html(),document_id:f,id:k,users_round_id:g},d=$(b).closest(textContent),f=d.attr("data-document-id"),g=d.attr("data-users-round-id"),l[k]={text_marked:d.html(),document_id:f,id:k,users_round_id:g},multisaveDocuments(l),updateRelationTable(a,b,relationId,f,c.id),showAllRelationsOption||createDomRelation(a,b),refreshRelations(l)}else a.removeClass(relationClass),b.removeClass(relationClass),errorDialog(c.message)})}function updateRelationTable(a,b,c,d,f){var g=$("#interRelationNodeTemplate").html(),k=$("#interRelationsTable>tbody"),l=a.attr(parseAnnotationIdAttr),m=b.attr(parseAnnotationIdAttr),n=classGenerator(a.attr(typeAtribute)),o=classGenerator(b.attr(typeAtribute)),p=typesMap[a.attr(typeAtribute)],q=typesMap[b.attr(typeAtribute)],r=$("a.relation[data-relation-id="+c+"]"),s="";$(annotationTag+"["+parseAnnotationIdAttr+"="+l+"]").each(function(){s+=$(this).text()});var t="";$(annotationTag+"["+parseAnnotationIdAttr+"="+m+"]").each(function(){t+=$(this).text()});var u=g.format(f,d,l,m,n,p.Type.name,s,r.text(),r.attr("data-colour"),o,q.Type.name,t,c);k.append(u)}function createDomRelation(a,b,c){showAllRelationsOption||clearInterRelations(),c=c||!1;var d=a.attr(parseAnnotationIdAttr),f=a.text(),g=b.attr(parseAnnotationIdAttr),k=b.text(),l=popoverTemplate.format(f,relationText,colour,k,d,g,lastInterRelationId);$(annotationTag+"["+parseAnnotationIdAttr+"="+d+"]").addClass(showRelationClass),$(annotationTag+"["+parseAnnotationIdAttr+"="+g+"]").addClass(showRelationClass);var m=a.offset(),n=b.offset(),o=["vertical","horizontal"],p=o[getRandomInt(0,1)],q=o[getRandomInt(0,1)];if(actualLine=jqSimpleConnect.connect(a,b,{radius:4,color:colour,anchorA:"vertical",anchorB:"vertical",container:parent}),void 0==n||void 0==m)removeInterelation(a,b,lastInterRelationId);else{directed&&($("#"+actualLine+"_2").css("z-index",99),n.top>m.top-10&&n.top<m.top+10?m.left<n.left?$("#"+actualLine+"_2").html("<div class=\"line-directed\"><img src=\""+markyLoctaion+"img/final-"+marker+".svg\"></div>"):$("#"+actualLine+"_2").html("<div class=\"line-directed inverted\"><img src=\""+markyLoctaion+"img/final-"+marker+".svg\"></div>"):m.top>n.top?$("#"+actualLine+"_2").html("<div class=\"line-directed inverted\"><img src=\""+markyLoctaion+"img/final-"+marker+".svg\"></div>"):$("#"+actualLine+"_2").html("<div class=\"line-directed\"><img src=\""+markyLoctaion+"img/final-"+marker+".svg\"></div>"));var r={placement:"top",container:"body",trigger:"manual",html:!0,content:function(){return l}},s=null;switch($("."+actualLine).popover(r).mouseover(function(){$(".jqSimpleConnect ").not("#"+$(this).attr("id")).popover("hide"),$(".popover").popover("hide"),$(".popover").remove();var u=$(this);s=setTimeout(function(){u.popover("show")},500)}).mouseout(function(){clearTimeout(s);var u=$(this);setTimeout(function(){u.popover("hide")},15000)}).addClass("InterRelationEdge-"+lastInterRelationId),borderType){case 1:$("."+actualLine).addClass("solid");break;case 2:$("."+actualLine).addClass("none");break;case 3:$("."+actualLine).addClass("dotted");break;case 4:$("."+actualLine).addClass("dashed");break;default:4<borderType&&$("."+actualLine).css("border-color",function(t){return"#000000".substr(0,7-t.length)+t}((~~(16777216*Math.random())).toString(16))),$("."+actualLine).addClass("none"),borderType=0;}}}function addLinkMouseMove(a,b){originElement=a,colour=b.attr("data-colour"),relationId=b.attr("data-relation-id"),marker=b.attr("data-marker"),directed=b.attr("data-directed");var c="<div id=\"new-link-line\"></div>";directed&&(c="<div id=\"new-link-line\"><div class=\"line-directed\"><img src=\""+markyLoctaion+"img/final-"+marker+".svg\"></div></div>");var d=$(c).appendTo("body"),f=originElement.width(),g=originElement.offset();if(pos.x=g.left+parseInt(f/2,10),pos.y=g.top+parseInt(originElement.height()/2,10),f>originElement.getRealDimensions().width+10){wrapped=!0,pos.x=g.left+parseInt(originElement.getRealDimensions().width/4);var k=originElement.height()/2;pos.y=g.top+parseInt(k+k/2,10)}d.css("top",pos.y).css("left",pos.x),$(document).mousemove(linkMouseMoveEvent)}function linkMouseMoveEvent(a){if(inRelationMode=!0,void 0!==originElement){colour=colour||"#000";var b=a.pageX-5,c=a.pageY-5,d=Math.sqrt((b-pos.x)*(b-pos.x)+(c-pos.y)*(c-pos.y)),f=180/3.1415*Math.acos((c-pos.y)/d);b>pos.x&&(f*=-1),d-=30,$("#new-link-line").css("height",d).css("background-color",colour).css("-webkit-transform","rotate("+f+"deg)").css("-moz-transform","rotate("+f+"deg)").css("-o-transform","rotate("+f+"deg)").css("-ms-transform","rotate("+f+"deg)").css("transform","rotate("+f+"deg)")}}function endLinkMode(){$("#new-link-line").remove(),originElement=null,pos={},inRelationMode=!1}function addInterRelationId(a,b,c,d){var f=a.attr(parseAnnotationIdAttr),g=b.attr(parseAnnotationIdAttr);f in interRelationsMap||(interRelationsMap[f]={}),g in interRelationsMap||(interRelationsMap[g]={}),lastInterRelationId=d,relationsMap[c]!=void 0&&(colour=relationsMap[c].colour,directed=relationsMap[c].is_directed,marker=relationsMap[c].marker,relationText=relationsMap[c].name),g in interRelationsMap[f]||(interRelationsMap[f][g]={}),f in interRelationsMap[g]||(interRelationsMap[g][f]={}),c in interRelationsMap[f][g]||(interRelationsMap[f][g][c]={}),c in interRelationsMap[g][f]||(interRelationsMap[g][f][c]={}),interRelationsMap[f][g][c].relationId=c,interRelationsMap[f][g][c].directedTo=g,interRelationsMap[f][g][c].interRelationId=d,interRelationsMap[g][f][c].relationId=c,interRelationsMap[g][f][c].directedTo=g,interRelationsMap[g][f][c].interRelationId=d,$(annotationTag+"["+parseAnnotationIdAttr+"="+f+"]").addClass(relationClass),$(annotationTag+"["+parseAnnotationIdAttr+"="+g+"]").addClass(relationClass);var k=a.closest(textContent),l=k.attr("data-document-id"),m=k.attr("data-document-annotated-id");"undefined"!=typeof lastPositionAction&&(lastPositionAction.page=$("#page").val(),lastPositionAction.document=m,localStorage.setItem("lastPositionAction",JSON.stringify(lastPositionAction))),"undefined"!=typeof undoActions&&undoActions.push({type:"createRelation",elementA:a,elementB:b,interRelationId:d})}function removeInterRelationOfMapAndDom(a,b,c){var d=a.attr(parseAnnotationIdAttr),f=b.attr(parseAnnotationIdAttr),g=a.closest(textContent),k=g.attr("data-document-id"),l=g.attr("data-document-annotated-id");"undefined"!=typeof lastPositionAction&&(lastPositionAction.document=l,lastPositionAction.page=$("#page").val(),localStorage.setItem("lastPositionAction",JSON.stringify(lastPositionAction))),$("#interRelationNode-"+c).remove(),$(".InterRelationEdge-"+c).remove(),removeElementFromInterRelationsMap(d,f,c),removeElementFromInterRelationsMap(f,d,c)}function removeElementFromInterRelationsMap(a,b,c){if(a in interRelationsMap&&b in interRelationsMap[a])for(var d in interRelationsMap[a][b])interRelationsMap[a][b][d].interRelationId==c&&(delete interRelationsMap[a][b][d],0==Object.keys(interRelationsMap[a][b]).length&&delete interRelationsMap[a][b],0==Object.keys(interRelationsMap[a]).length&&$(annotationTag+"["+parseAnnotationIdAttr+"="+a+"]").removeClass(relationClass).removeClass(showRelationClass))}function removeInterelationsOfElement(a){if(a!==void 0&&a.hasClass(relationClass)){var b=a.attr(parseAnnotationIdAttr);if(b in interRelationsMap){var c=interRelationsMap[b],f=[],g=-1;$(".pulsar").removeClass("pulsar"),$(textContent+" "+annotationTag+"."+relationClass).each(function(){var k=$(this).attr(parseAnnotationIdAttr);if(k in c){g=$(this).closest(textContent).attr("id"),f[g]=g;var l=c[k].interRelationId;removeInterRelationOfMapAndDom(a,$(this),l)}})}else a.removeClass(relationClass),g=a.closest(textContent).attr("id")}return f}function removeRelations(a){if(a!==void 0&&a.hasClass(relationClass)){var b=a.attr(parseAnnotationIdAttr),c=[],d;if(b in interRelationsMap)for(d in console.log(interRelationsMap[b]),interRelationsMap[b])c.push(interRelationsMap[b][d].interRelationId);var d=0,g=0,k=0,l=0,m=[];$("#myModal").modal(),$.ajax({type:"POST",url:markyLoctaion+"annotationsInterRelations/deleteSelected/",data:{"selected-items":JSON.stringify(c)}}).done(function(o){if(o.success){var p=removeInterelationsOfElement(a);if(isMultidocument){for(d in clearTexts(),refreshRelations(p),p)g=$("#"+d),k=g.attr("data-document-id"),l=g.attr("data-users-round-id"),m[d]={text_marked:g.html(),document_id:k,id:d,users_round_id:l};multisaveDocuments(m,function(){$("#myModal").modal("hide")})}}else errorDialog(o.message)})}}function showAllRelations(){clearInterRelations(!0);var a=jQuery.extend(!0,{},interRelationsMap),b=[];$(textContent+" "+annotationTag+"."+relationClass).each(function(){var c=$(this);if(c.hasClass(relationClass)){var d=c.attr(parseAnnotationIdAttr);if(d in a){var f=a[d];borderType=1,$(textContent+" "+annotationTag+"."+relationClass).each(function(){if($(this).hasClass(relationClass)&&!$(this).is(c)){var g=$(this).attr(parseAnnotationIdAttr);if(g in f)for(var k in f[g]){var l=f[g][k].directedTo;if(!("showed"in a[d][g][k])){a[d][g][k].showed=!0,a[g][d][k].showed=!0;var m=a[d][g][k];colour=relationsMap[k].colour,directed=relationsMap[k].is_directed,marker=relationsMap[k].marker,relationText=relationsMap[k].name,lastInterRelationId=m.interRelationId,$.inArray(lastInterRelationId,b)&&(b.push(lastInterRelationId),lastColor===colour&&borderType++,lastColor=colour,l==d?createDomRelation($(this),c,!0):createDomRelation(c,$(this),!0))}}}}),lastColor="",borderType=0}}})}function showInterRelations(a){if(clearInterRelations(),a.hasClass(relationClass)){var b=a.attr(parseAnnotationIdAttr);if(b in interRelationsMap){var c=interRelationsMap[b];borderType=1,$(textContent+" "+annotationTag+"."+relationClass).each(function(){if($(this).hasClass(relationClass)&&!$(this).is(a)&&(b=$(this).attr(parseAnnotationIdAttr),b in c))for(var d in c[b])colour=relationsMap[d].colour,directed=relationsMap[d].is_directed,marker=relationsMap[d].marker,relationText=relationsMap[d].name,targetId=c[b][d].directedTo,lastInterRelationId=c[b][d].interRelationId,lastColor===colour&&borderType++,lastColor=colour,targetId==b?createDomRelation(a,$(this),!0):createDomRelation($(this),a,!0)}),lastColor="",borderType=0}}}function updateInterelationsMap(){interRelationsMap=JSON.parse($("#interRelationsMap").val()),0==interRelationsMap.length&&(interRelationsMap={})}function refreshRelations(a){$(".jqSimpleConnect").popover("hide");var b=[];if(showAllRelationsOption)for(var c in a)$("#"+c).find(annotationTag+"."+relationClass).each(function(){var d=$(this),f=$(this).attr(parseAnnotationIdAttr);for(var g in b[f]=!0,interRelationsMap[f])if(!b[g]){var k=interRelationsMap[f][g];for(var l in k){lastInterRelationId=k[l].interRelationId;var m=$(annotationTag+"["+parseAnnotationIdAttr+"="+g+"]");$(".InterRelationEdge-"+lastInterRelationId).remove(),colour=relationsMap[l].colour,directed=relationsMap[l].is_directed,marker=relationsMap[l].marker,relationText=relationsMap[l].name;var n=interRelationsMap[f][g][l],o=n.directedTo;o==f?createDomRelation(m,d,!1):createDomRelation(d,m,!1)}}})}function clearInterRelations(a){a=a||!1,(!showAllRelationsOption||a)&&($(".showRelation").removeClass(showRelationClass),$(".jqSimpleConnect").popover("hide"),jqSimpleConnect.removeAll()),$(".popover").remove()}$(window).resize(function(){responsiveBar()});function responsiveBar(){var a=$(window).width()+10;1200<=a||!openRelationBar?($("#sidebar-menu").removeClass("sidebar-midle"),$("#relationsContainer").removeClass("relationsContent-midle"),$("#content").removeClass("content-midle"),responsive=!1):1200>a&&!responsive&&openRelationBar&&($("#sidebar-menu").addClass("sidebar-midle"),$("#relationsContainer").addClass("relationsContent-midle"),$("#content").addClass("content-midle"),responsive=!0)}function showRelationsBar(){openRelationBar=!0,showAllRelationsOption=!1,$("#viewRelations").removeClass("active"),parent="#content",responsiveBar(),$("#sidebar-menu").removeClass("col-md-1").addClass("row-fluid").addClass("col-md-3"),$("#sidebar-menu .btn-group-vertical").hide(200),$("#sidebar-menu").addClass("row-fluid").addClass("open"),$("div#affix-sidebar").addClass("row-fluid").removeClass("col-md-2").css("width","1%"),$("body").css("overflow","hidden"),$("#content").addClass("row-fluid").addClass("scrollableContent"),$("#documentBodyContainer").removeClass("col-md-11").addClass("row-fluid").addClass("col-md-12"),$("#context-menu").attr("data-target","#content"),$("#relationsBar").show(),$("#documentBody").css("heigth",$(window).height()+"px"),clearInterRelations()}function hideRelationsBar(){openRelationBar=!1,parent="body",responsiveBar(),$("#relationsBar").hide(200),$("#sidebar-menu").removeClass("col-md-3").addClass("row-fluid").addClass("col-md-1"),$("#documentBodyContainer").removeClass("col-md-9").addClass("row-fluid").addClass("col-md-11"),$("#sidebar-menu").removeClass("col-md-3").addClass("row-fluid").addClass("col-md-1"),$("#sidebar-menu").addClass("row-fluid").removeClass("open"),$("#context-menu").removeAttr("data-target"),$("div#affix-sidebar").addClass("row-fluid").addClass("col-md-2").css("width",""),$("body").css("overflow","auto"),$("#content").addClass("row-fluid").removeClass("scrollableContent"),$("mark.pulsar").removeClass("pulsar"),$("#documentBodyContainer").removeClass("col-md-12").addClass("row-fluid").addClass("col-md-11"),$("#sidebar-menu .btn-group-vertical").show(800),clearInterRelations(!0)}function removeInterelation(a,b,c){var d=a.attr(parseAnnotationIdAttr),f=b.attr(parseAnnotationIdAttr);return null==c||-1==c?errorDialog("inter relation id  not found"):void($("#myModal").modal(),d in interRelationsMap&&f in interRelationsMap?$.ajax({type:"POST",url:markyLoctaion+"annotationsInterRelations/deleteSelected/",data:{"selected-items":"["+c+"]"}}).done(function(g){g.success?removeHTMLInteRelationAndSaveDocument(a,b,c):errorDialog(g.message)}):(removeInterRelationOfMapAndDom(a,b,c),removeHTMLInteRelationAndSaveDocument(a,b,c)))}function removeHTMLInteRelationAndSaveDocument(a,b,c){var d=0,f=0,g=0,k=[],l=0,m=[],n=-1;if(n=a.closest(textContent).attr("id"),m[n]=n,n=b.closest(textContent).attr("id"),m[n]=n,!(0<m.length))$("#myModal").modal("hide");else if(removeInterRelationOfMapAndDom(a,b,c),isMultidocument){for(l in clearTexts(),refreshRelations(m),m)d=$("#"+l),f=d.attr("data-document-id"),g=d.attr("data-users-round-id"),k[l]={text_marked:d.html(),document_id:f,id:l,users_round_id:g};multisaveDocuments(k,function(){$("#myModal").modal("hide"),clearInterRelations()})}}function getRandomInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}