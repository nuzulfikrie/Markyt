function initialiceId(){idDate="Marky",idDate+=$("#time").attr("value"),idDate=idDate.replace(/[:-]/g,"")}function getId(){if(isOffline)return annotationCount;if(void 0!==annotationDatabaseId&&null!==annotationDatabaseId)return annotationDatabaseId;throw alert("It happened an unexpected error: Id not found"),"id not found"}function timerLiftOff(){ocupado?endTime=!0:$("form#roundSave").submit()}function timeEvents(t){$.countdown.periodsToSeconds(t)===autoSaveMinutes-10&&$("#flashMessage").remove(),60===$.countdown.periodsToSeconds(t)&&$(this).addClass("redTime")}function responsiveFunctions(){$(window).width()}function topSidebar(){$("#content").removeClass().addClass("col-md-12").css("margin-top","180px").css("padding-left","5%").css("padding-right","5%"),$("#affix-sidebar").removeClass().addClass("navbar navbar-default navbar-fixed-top ").addClass("navbar-top").css("color","#808B9C"),$("#affix-sidebar .sidebar-nav").removeClass().addClass("markyTopNavBar"),isEnd?($(".pagination-content").removeClass("col-xs-6").addClass("end").appendTo("#counterDesc").css("height","60px"),$("#counterDesc").css("width","100%")):$("#affix-sidebar div.markyTopNavBar .types-annotations").css("height","90px")}function repareSection(t){var e;0!==t.closest("h3.title").length?e="T":0!==t.closest("div.abstract").length&&(e="A"),$.ajax({type:"POST",url:markyLoctaion+"annotationsQuestions/updateSection",data:{section:e,id:t.attr(parseAnnotationIdAttr)}}).done(function(t){t.success||location.reload()})}function getPageAjax(t,e){clearInterRelations(),undoActions=[],e=e||-1,$("#overlay").modal(),paginationAjax?$.ajax({type:"GET",url:t,success:function(n){updatePageAjax(n);var a=t.indexOf(":"),o=-1;o=-1===a?1:t.substring(a+1),window.history.replaceState("","Page "+o,t),$("mark.automatic").tooltip({container:"body",title:"Automatic annotation"}),$("#jumpTo").popover("hide"),jumpToOpen=!1,-1!=e?scrollToElement($("a[name='"+e+"']")):(lastPosition=(o-1)*documentsPerPage,$("#page").val(o).change(),$("#documentSelector").val(o),$("#documentSelector").trigger("chosen:updated"))},fail:function(t,e,n){errorDialog(e),location.reload()}}):window.location.replace(t)}function updatePageAjax(t){var e=$("<div/>").html(t);$("#counterDesc").removeClass("redTime").countdown("option",{until:+autoSaveMinutes,format:"MS",onExpiry:timerLiftOff,compact:!0,description:"Autosave",onTick:timeEvents}),isCorpusModify=!1,$("#documentBody").html(e.find("#documentBody").html());var n=e.find("#pagination-content").html();$("#pagination-content").html(n),$("#relationsContainer").html(e.find("#interRelationsTable").html()),updateInterelationsMap(),createRelationsDatatable(),$("#query").val(""),initializeAnnotations(),disableMultiSelection(),showAllRelationsOption&&(clearInterRelations(!0),setTimeout(function(){showAllRelations()},500)),$("#overlay").modal("hide")}function initializeAnnotations(){isEnd?$(annotationTag+"[name=annotation]").mouseup(function(t){t.stopPropagation(),annotationEditRemove(t)}):($(textContent+" "+annotationTag+"[name=annotation]").each(function(){$(this).mouseup(function(t){t.stopPropagation(),annotationEditRemove(t)})}),$(textContent).css("cursor","url("+markyLoctaion+"img/highlighter_yellow.cur),auto")),$(document).ajaxStart(function(){$("#content").addClass("loading")}).ajaxStop(function(){$("#content").removeClass("loading")})}function arrayToCSS(t,e){var n="\n."+t+"{";for(var a in e)e.hasOwnProperty(a)&&(n+="\t"+a+":"+e[a]+";\n");return n+="}\n\n"}function createDinamicCSS(t,e){var n,a=classGenerator(t);return n=arrayToCSS(a,{"background-color":"rgba("+e+") !important","-webkit-print-color-adjust":"exact !important"}),n+="@media print {\t"+arrayToCSS(a,{"background-color":"rgba("+e+") !important"})+"}\n"}function classGenerator(t){return annotationDefaultKeyClass+t}function createRangyCSS(t){highlighter.addClassApplier(rangy.createCssClassApplier(t,{useExistingElements:!1,ignoreWhiteSpace:!0,elementTagName:annotationTag,onElementCreate:function(t){if(void 0!==getId()&&null!==getId()){var e=typeSelected.attr(typeAtribute),n=classGenerator(e);$(t).attr("data-parse-key",parseKey).attr(typeAtribute,e).attr(parseAnnotationIdAttr,getId()).attr("name",annotationDefaultName).addClass(annotationDefaultClass).addClass(n),annotationHasAnswers&&$(t).addClass(annotationHasAnswersClass),lastAnnotation=$(t),undoActions.push({type:"createAnnotation",element:lastAnnotation})}else removeAnnotations($(t)),errorDialog("Where is Id?")},elementProperties:{onmouseup:function(t){t.preventDefault(),annotationEditRemove(t)}}}))}function isCanvasSupported(){var t=document.createElement("canvas");return!(!t.getContext||!t.getContext("2d"))}function createRelation(t,e){}function annotationEditRemove(t){t.stopPropagation();var e=$(t.target);if(2===t.button&&!1===creatingRelation&&!1===disableAnnotations){isEnd&&$("#context-menu").find(".notEnd").addClass("hidden"),isJavaActionEnabled||$("#context-menu").find(".java-action").addClass("hidden"),e.hasClass(relationClass)?$("#context-menu").find(".hasRelationOption").removeClass("hidden"):$("#context-menu").find(".hasRelationOption").addClass("hidden");var n=e.attr(typeAtribute);$("#context-menu").find(".label").css("background-color",colourMap[n]),$("#context-menu").contextMenu({evt:t,menuSelected:function(t){var a=t.attr("tabindex"),o=e.attr(parseAnnotationIdAttr),i=$.trim(e.text());switch(a){case"1":case"2":editViewAnnotation(e);break;case"3":multiAnnotationValidations(n,i);break;case"4":if((c=e.attr(typeAtribute))!==(u=t.attr(typeAtribute))){$("#myModal").modal();var s=e.closest(textContent),r=s.attr("data-document-id"),l=s.attr("data-document-annotated-id");e.removeClass(classGenerator(c)),e.addClass(classGenerator(u)),e.attr(typeAtribute,u);var d=s.html();$.ajax({type:"POST",url:markyLoctaion+"annotationsQuestions/changeType/",data:{id:o,to_type:t.attr(typeAtribute),html:d,annotated_document_id:l,document_id:r}}).done(function(t){t.success?($("#myModal").modal("hide"),void 0!==lastPositionAction&&(lastPositionAction.document=l,lastPositionAction.page=$("#page").val(),localStorage.setItem("lastPositionAction",JSON.stringify(lastPositionAction)))):errorDialog(t.message,function(){location.reload()})}).fail(function(t,e,n){errorDialog(e)})}break;case"5":var c=e.attr(typeAtribute),u=t.attr(typeAtribute);c!==u&&sendJob({operation:"changeType",newType:u,term:i});break;case"6":isEnd||confirmDeleteDialog(function(){isCorpusModify=!0;removeAnnotations($(annotationTag+"["+parseAnnotationIdAttr+"="+o+"]"))});break;case"7":isEnd||confirmDeleteDialog(function(){var t=e.attr(typeAtribute);isJavaActionEnabled?sendJob({operation:"deleteAllTermWithType",type_id:t,term:i}):(isCorpusModify=!0,removeAnnotations($(annotationTag+"["+typeAtribute+"="+t+"]")))},$("#multi-annotation-delete-confirm").text());break;case"8":isEnd||confirmDeleteDialog(function(){var t=e.text().toLowerCase();if(isJavaActionEnabled)sendJob({operation:"deleteAllTerms",term:i});else{isCorpusModify=!0;for(var n=$(textContent+" "+annotationTag).filter(function(){return $(this).text().toLowerCase()==t}),a=0,s=null,r=[],a=0,l=n.length;a<l;++a)s=n[a],o=$(s).attr(parseAnnotationIdAttr),r.push($(annotationTag+"["+parseAnnotationIdAttr+"="+o+"]"));removeAnnotations(r)}},$("#multi-annotation-delete-confirm").text());break;case"deleteParents":isEnd||confirmDeleteDialog(function(){isCorpusModify=!0;var t=e.attr(parseAnnotationIdAttr),n=$(annotationTag+"["+parseAnnotationIdAttr+"="+t+"]").parents(".parentMark");n.each(function(){var t=$(this).attr(parseAnnotationIdAttr);n.add($(annotationTag+"["+parseAnnotationIdAttr+"="+t+"]"))}),removeAnnotations(n)},$("#multi-annotation-delete-confirm").text());break;case"9":OpenInNewTab("http://google.com/search?q="+e.text());break;case"10":var p=+t.attr("data-database-id");switch(console.log(p),p){case 0:OpenInNewTab("http://www.drugbank.ca/unearth/q?utf8=%E2%9C%93&query="+e.text()+"&searcher=drugs"),OpenInNewTab("http://www.ncbi.nlm.nih.gov/pccompound?term="+e.text()),OpenInNewTab("http://www.ebi.ac.uk/ebisearch/search.ebi?query="+e.text()),OpenInNewTab("http://www.uniprot.org/uniprot/?query="+e.text()+"&sort=score"),OpenInNewTab("http://www.ncbi.nlm.nih.gov/pubmed/?term="+e.text());break;case 1:OpenInNewTab("http://www.drugbank.ca/unearth/q?utf8=%E2%9C%93&query="+e.text()+"&searcher=drugs");break;case 2:OpenInNewTab("http://www.ncbi.nlm.nih.gov/pccompound?term="+e.text());break;case 3:OpenInNewTab("http://www.ebi.ac.uk/ebisearch/search.ebi?query="+e.text());break;case 4:OpenInNewTab("http://www.uniprot.org/uniprot/?query="+e.text()+"&sort=score");break;case 5:OpenInNewTab("http://bactibase.pfba-lab-tun.org/bacteriocinslist.php?q="+e.text());break;case 6:OpenInNewTab("http://www.ncbi.nlm.nih.gov/pubmed/?term="+e.text())}break;case"11":isEnd||(addLinkMouseMove(e,t),creatingRelation=!0,elementA=e);break;case"12":showInterRelations(e,relationsMap);break;case"13":removeRelations(e),clearInterRelations();break;case"14":clearInterRelations(!0)}}})}else 0===t.button&&(!1===creatingRelation?null===defaultRelation?allowNested?addAnnotation():editViewAnnotation(e):isEnd||(addLinkMouseMove(e,defaultRelation),creatingRelation=!0,elementA=e):(elementB=e,newReelation(elementA,elementB),creatingRelation=!1,elementA=null,elementB=null))}function OpenInNewTab(t){var e=window.open(t,"_blank");void 0!=e&&e.focus()}function sendJob(t){$("#cancelJavaJob").hasClass("bound")||($(this).addClass("bound"),$("#cancelJavaJob").click(function(){-1!=PID&&cancelJob(PID)})),$.ajax({type:"POST",url:markyLoctaion+"annotationsQuestions/javaAction/",data:t,success:function(t){t.success?($("#javaModal").modal({backdrop:"static",keyboard:!1}),$("#dialog-form").modal("hide"),PID=t.PID,updateStateEnd=!0,updateState(PID)):errorDialog(t.message)},error:function(t,e,n){errorDialog(n)}})}function updateState(t){updateStateEnd&&(updateStateEnd=!1,$.ajax({type:"POST",url:markyLoctaion+"annotationsQuestions/getJavaState",data:{id:t},success:function(e){if(updateStateEnd=!0,!cancellingJob)if(100==e.percent){$("#javaModal .bar").text(e.percent+"%").width(e.percent+"%");var n=$("#page").val();if(getPageAjax($("#canonical").attr("href")+"/page:"+n),void 0!=e.message&&""!=e.message){console.log(e.message);var a=null;"create"==e.action&&(a='<i class="fa fa-check-square-o fa-2"></i>'),"remove"==e.action&&(a='<i class="fa fa-eraser fa-2"></i>'),setTimeout(function(){$.sticky({icon:a,iconType:"i",title:"Notification",animations:{"bottom-right":["slideInUp","slideOutDown"]},body:e.message,position:"bottom-right",useAnimateCss:!0,hideAfter:1e4,closeable:!0})},500)}setTimeout(function(){$("#javaModal").modal("hide")},500)}else $("#javaModal .bar").parent().hasClass("progress-striped")&&$("#javaModal .bar").parent().removeClass("progress-striped"),$("#javaModal .bar").text(e.percent+"%").width(e.percent+"%"),setTimeout(function(){updateState(t)},5e3)},error:function(t,e,n){errorDialog(n)}}))}function cancelJob(t){cancellingJob=!0,$("#javaModal .bar").width("100%"),$("#javaModal .bar").text("Cancelling..."),$.ajax({type:"POST",url:markyLoctaion+"annotationsQuestions/javaAction/",data:{operation:-1,job_id:t},success:function(t){t.success?setTimeout(function(){reloadLocation()},3e3):$("#javaModal .bar").text("This operation can not be canceled! Try in few seconds").css("color","#FFCD5C")},error:function(t,e,n){errorDialog(n)}})}function removeAnnotations(t){var e,n,a,o=0,i=t.length,s=null,r=[];if(i>0){$("#myModal").modal(),$("#myModal .bar").parent().removeClass("progress-striped"),isCorpusModify=!0,ocupado=!0;var l=window.setInterval(function(){if(o<i){s=t[o],isMultidocument&&(e=$(s).closest(textContent),n=e.attr("data-document-id"),a=e.attr("id"),void 0===r[a]&&(r[a]={id:a,document_id:n})),removeInterelationsOfElement($(s));var d=$(s).attr(parseAnnotationIdAttr);$(annotationTag+"["+parseAnnotationIdAttr+"="+d+"]").each(function(){$(this).parents(".parentMark").each(function(){$(this).css("padding","-=3"),$(this).find("mark").length<=1&&$(this).removeClass("parentMark").css("padding","")}),$(this).contents().unwrap()}),o++,$("#myModal .bar").text(Math.round(o/i*100)+"%").width(Math.round(o/i*100)+"%")}else clearInterval(l),isMultidocument?multisaveDocuments(r,function(){$("#myModal").modal("hide"),ocupado=!1}):($("#myModal").modal("hide"),ocupado=!1)},100);$("#myModal .bar").width("100%").text(""),$("#myModal").parent().addClass("progress-striped")}}function editViewAnnotation(t){var e=t.attr(typeAtribute);annotationDatabaseId=t.attr(parseAnnotationIdAttr);var n=t.text(),a=-1;void 0!==typesMap[e]&&typesMap[e].Question.length>0?(isMultidocument&&(a=t.closest(textContent).attr("data-document-id")),$.ajax({type:"GET",url:markyLoctaion+"annotationsQuestions/view/"+annotationDatabaseId,data:{type_id:e,document_id:a}}).done(function(t){t.success?(t.selectedText=n,cancelSelection(),questionsDialog(t,function(){saveAnswers(e,n,annotationDatabaseId,function(){annotationHasAnswers?$(annotationTag+"["+parseAnnotationIdAttr+"="+annotationDatabaseId+"]").each(function(){$(this).removeClass(automaticAnnotationClass).addClass(annotationHasAnswersClass)}):$(annotationTag+"["+parseAnnotationIdAttr+"="+annotationDatabaseId+"]").each(function(){$(this).removeClass(annotationHasAnswersClass)}),$("#dialog-form").modal("hide")})})):errorDialog(t.message)}).fail(function(t,e,n){errorDialog(e)})):noQuestionsDialog()}function removeHighlightFromSelectedText(){highlighter.unhighlightSelection()}function annotationHelpers(){if(!disableHelpers){var t=rangy.getSelection();if(text=t.toString(),trim_helper){n=t.getRangeAt(0);(o=/^\s+/.exec(text))&&n.moveStart("character",o[0].length),(o=/\s+|\n+$/.exec(text))&&n.moveEnd("character",-o[0].length),t.setSingleRange(n)}if(whole_word_helper&&t.expand("word",{trim:!0,wordOptions:{wordRegex:unicodeRegex}}),punctuation_helper){var e=unicodeCharacters,n=t.getRangeAt(0),a=t.toString();a=$.trim(a),checkBrackets(a)?(a.search("[^(]+\\(.*")>-1&&(e+="\\)"),a.search("["+e+"]+\\)[^"+e+"].["+e+"]+")>-1&&(e+="\\(")):(a.search("["+e+"]*\\(.*")>-1&&(e+="\\)"),a.search("["+e+"]*\\[.*")>-1&&(e+="\\]"));var o=XRegExp.cache("^[^A-Za-z0-9"+e+"]").exec(a);null!=o&&n.moveStart("character",o[0].length),t.setSingleRange(n),a=t.toString();var i="[^A-Za-z0-9"+e+"]*$";if((o=XRegExp.cache(i).exec(a))&&null!=o[0]&&n.moveEnd("character",-o[0].length),t.setSingleRange(n),a=t.toString(),o=XRegExp.cache("\\)*$").exec(a),!checkBrackets(a)&&null!=o){var s=(a.match(/\(/g)||[]).length,r=(a.match(/\)/g)||[]).length-s;(o=XRegExp.cache("\\){1,"+r+"}$").exec(a))&&n.moveEnd("character",-o[0].length),t.setSingleRange(n),a=t.toString()}t.setSingleRange(n),a=t.toString(),checkBrackets(a)&&-1!=a.search("^[\\(|\\[]")&&-1!=a.search("[\\)|\\]]$")&&(n.moveEnd("character",-1),n.moveStart("character",1),t.setSingleRange(n))}}}function addAnnotation(){var t,e,n,a=a||window.event,o="",i=rangy.getSelection();if(o=i.toString(),annotationHasAnswers=!1,console.log("Left Mouse button pressed."),!isEnd&&void 0!==i&&""!==o&&null!==typeSelected&&!disableAnnotations&&o.length>0)if(annotationHelpers(),o=i.toString(),existOverlaping())noOverlapsDialog();else{o=i.toString(),ocupado=!0,void 0==typeSelected&&(typeSelected=$(".types-annotations button").first().attr("disabled","disabled")),e=typeSelected.attr(typeAtribute),void 0!=typesMap[e]&&(n=typesMap[e].Question);var s=$(i.focusNode).closest(textContent);if(savedSel=rangy.saveSelection(),void 0!==n){var r=s.attr("data-document-id"),l=s.attr("id");t=n.length;var d=getSection(i);t>0?$.ajax({type:"GET",url:markyLoctaion+"annotationsQuestions/view/",data:{type_id:e,text:$.trim(o)}}).done(function(t){t.success?(t.selectedText=o,t.typeId=e,questionsDialog(t,function(){$.ajax({type:"POST",url:markyLoctaion+"annotationsQuestions/addAnnotation/",data:{type_id:e,text:$.trim(o),section:d,document_id:r,document_annotated_id:l}}).done(function(t){void 0!==t.id?(annotationCount++,annotationDatabaseId=t.id,saveAnswers(e,o,annotationDatabaseId,function(){savedSel&&(rangy.restoreSelection(savedSel,!0),annoteSelectedText()),$("#dialog-form").modal("hide")})):(ocupado=!1,errorDialog("Where is data id?"))}).fail(function(t,e,n){errorDialog("annotationsQuestions/addAnnotation/ "+e)})})):errorDialog(t.message)}).fail(function(t,e,n){errorDialog(e)}):$.ajax({type:"POST",url:markyLoctaion+"annotationsQuestions/addAnnotation/",data:{type_id:e,text:$.trim(o),section:d,document_id:r,document_annotated_id:l}}).done(function(t){t.success?void 0!==t.id?warningTypeDialog(e,t.lastAnnotation,function(){annotationCount++,annotationDatabaseId=t.id,rangy.restoreSelection(savedSel,!0),annoteSelectedText()}):errorDialog("Where is data id?"):errorDialog(t.message)}).fail(function(t,e,n){errorDialog("annotationsQuestions/addAnnotation/ "+e)})}}null!=editViewAnnotationTimeout&&(editViewAnnotationTimeout=null,clearTimeout(timeout)),$(a.target).is("mark")&&0===a.button&&setTimeout(function(){return a.preventDefault(),a.stopPropagation(),editViewAnnotation($(a.target)),!1},400)}function getSection(t){var e="U";if(null!==t.focusNode&&$(t.anchorNode).is("h3.title")&&$(t.focusNode).is("div.abstract"))throw alert("It happened an unexpected error: diferent sections"),"diferent sections";if($("div.corpusSections").length>0&&($(t.focusNode).is("h3.title")?e="T":$(t.focusNode).is("div.abstract")&&(e="A"),null===e&&(0!==$(t.focusNode).closest("h3.title").length?e="T":0!==$(t.focusNode).closest("div.abstract").length&&(e="A")),null===e)){var n=t;if(n.rangeCount>0){var a=n.getRangeAt(0).toCharacterRange($(textContent).get(0)),o=a.start,i=a.end,s=$("div.corpusSections h3.title").text().length;o>s&&i>s?e="A":o<s&&i<s&&(e="T")}if(null===e)throw alert("It happened an unexpected error: Section not found"),"section not found"}return e}function getAnswers(){var t=[],e="",n=0;return dialogForm.find("textarea").each(function(){-1!=$(this).attr("data-element-id")?(e=$(this).val(),t.push({id:$(this).attr("data-element-id"),question_id:$(this).attr("data-question-id"),answer:$(this).val()}),""!==$.trim(e)&&n++):(e=$(this).val(),""!==$.trim(e)&&(t.push({annotation_id:annotationDatabaseId,question_id:$(this).attr("data-question-id"),answer:e}),n++))}),annotationHasAnswers=0!==n,t}function saveAnswers(t,e,n,a){var o=getAnswers();o.length>0?$.ajax({type:"POST",url:markyLoctaion+"annotationsQuestions/save/",data:{type_id:t,annotation:e,answers:JSON.stringify(o),annotation_id:n}}).done(function(t){t.success?a():errorDialog(t.message)}):a()}function annoteSelectedText(t){isCorpusModify=!0;var e,t=!1|t;if(isMultidocument&&!t){var n=rangy.getSelection(),a=(e=$(n.focusNode).closest(textContent)).attr("data-document-id"),o=e.attr("id");void 0!==lastPositionAction&&(lastPositionAction.document=o,lastPositionAction.page=$("#page").val(),localStorage.setItem("lastPositionAction",JSON.stringify(lastPositionAction)))}if(highlighter.highlightSelection(annotationTemporallyClass,{exclusive:!0}),$(annotationTag+"["+parseAnnotationIdAttr+"="+getId()+"]").parents(annotationTag).each(function(){$(this).addClass("parentMark").css("padding","+=2")}),null!==savedSel&&rangy.removeMarkers(savedSel),highlighter.removeAllHighlights(),cancelSelection(),isMultidocument&&!t){var i=[];i[o]={text_marked:e.html(),document_id:a,id:o},multisaveDocuments(i)}ocupado=!1}function cancelSelection(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty();var t=window.getSelection?window.getSelection():document.selection;t&&(t.removeAllRanges?t.removeAllRanges():t.empty&&t.empty()),$(".rangySelectionBoundary").remove(),(t=rangy.getSelection()).refresh()}function changeSelectColor(t){var e;if(void 0!=t){e=RGBtoHEX(e=typesMap[t].Type.colour),$("#annotateButton").css("background-color",e),$("#annotateButton").css("border-color",e);try{isFirefox?jss.set(textContent+" *::-moz-selection",{background:e}):jss.set(textContent+" *::selection",{background:e})}catch(t){}}}function toHex(t){return null===t?"00":0===(t=parseInt(t))||isNaN(t)?"00":(t=Math.max(0,t),t=Math.min(t,255),t=Math.round(t),"0123456789ABCDEF".charAt((t-t%16)/16)+"0123456789ABCDEF".charAt(t%16))}function RGBtoHEX(t){var e=t.split(","),n=e[0],a=e[1],o=e[2];return"#"+[toHex(n),toHex(a),toHex(o)].join("")}function existOverlaping(){if(allowNested)return!1;var t=rangy.getSelection(),e=t.toHtml(),n=t.getRangeAt(0);return $(getAntecesor(n)).is(annotationTag)||-1!==e.indexOf("<"+annotationTag)||-1!==e.indexOf("<img")}function disableMultiSelection(){$("#annotateButton").prop("disabled",!0),isJavaActionEnabled||$("#findOcurrencesText span.label").fadeOut("slow")}function enableMultiSelection(){$("#findOcurrencesText span.label").css("visibility","visible").hide().fadeIn("slow"),$("#annotateButton").prop("disabled",!1)}function multiselection(){function t(){if(a=0,isMultidocument){o=[];var t,e,l}else o={T:0,A:0};var c=$.trim($("#query").val());if(c.length>=3)if(isJavaActionEnabled)$("#annotateButton").prop("disabled",!1).removeClass("disabled"),s=!0;else{$("#query").prop("disabled",!0),s=!1,r.start();var u=rangy.createRange();u.selectNodeContents($("#documentBody").get(0)),searchResultApplier.undoToRange(u),diableReturnKey=!0,n=window.setInterval(function(){if(u.findText(c,mutiAnnotateOptions)){if(u.select(),!existOverlaping()){if(d++,searchResultApplier.applyToRange(u),isMultidocument){m=rangy.getSelection(),t=$(m.focusNode).closest(textContent),e=t.attr("data-document-id"),l=t.attr("id");var p={document_id:e,document_annotated_id:l};i&&(p.section=getSection(m)),o.push(p)}else if(i){var m=rangy.getSelection(),g=getSection(m);"T"===g?o.T=o.T+1:"A"===g&&(o.A=o.A+1)}a++}u.collapse(!1)}else r.stop(),d>0?($("#findOcurrences").text(d),$("#findOcurrencesText span.label").css("visibility","visible").hide().fadeIn("slow"),$("#annotateButton").prop("disabled",!1).removeClass("disabled")):($("#findOcurrences").text(d),$("#findOcurrencesText span.label").css("visibility","visible").hide().fadeIn("slow"),$("#annotateButton").prop("disabled",!0).addClass("disabled")),s=!0,diableReturnKey=!1,$("#query").prop("disabled",!1),cancelSelection(),clearInterval(n)},timeOutInterval)}else $("#annotateButton").prop("disabled",!0).addClass("disabled")}var e,n,a=0,o={},i=$("div.corpusSections").length>0,s=!1,r=Ladda.create(document.querySelector("#annotateButton")),l="",d=0;$("#query").keydown(function(){clearTimeout(e),clearInterval(n);var a=$("#query").val();a.length>0&&l!==a&&(d=0,$("#findOcurrencesText span.label").fadeOut("slow"),e=setTimeout(t,1e3)),l=a}),$("#query").bind("paste",function(){clearTimeout(e),clearInterval(n),d=0,$("#findOcurrencesText span.label").fadeOut("slow"),setTimeout(function(){t()},1e3)}),$(textContent).mousedown(function(){clearInterval(n),clearTimeout(e),r.stop(),$("#query").prop("disabled",!1),disableMultiSelection(),cancelSelection();var t=rangy.createRange();t.selectNodeContents($(textContent).get(0)),searchResultApplier.undoToRange(t)}),$("#annotateButton").click(function(){var t=typeSelected.attr(typeAtribute),e=$.trim($("#query").val());e.length>=3&&s&&multiAnnotationValidations(t,e,a,o,r)})}function multiAnnotateSelectedText(t,e,n,a,o,i){i.start(),range.selectNodeContents($(textContent).get(0)),searchResultApplier.undoToRange(range);var s=$("div.corpusSections").length>0,r={type_id:t,text:$.trim(e),answers:n,numberOfAnnotations:a};r.annotationsMap=o,$.ajax({type:"POST",url:markyLoctaion+"annotationsQuestions/multiAdd/",data:r}).done(function(t){if(t.success&&void 0!==t.annotation_ids){ocupado=!0,isCorpusModify=!0;var n=t.annotation_ids,o=t.annotationIdsMap,r=rangy.createRange(),l=0,d=0;$("#myModal").modal();var c,u=[];r.selectNodeContents($("#documentBody").get(0)),c=window.setInterval(function(){if(r.findText(e,mutiAnnotateOptions)&&void 0!==n[l]){r.select();var t=p,p=!1;if(annotationHelpers(),p=t,!existOverlaping()){if(annotationCount++,isMultidocument){var m=rangy.getSelection(),g=$(m.focusNode).closest(textContent),f=g.attr("data-document-id"),h=g.attr("id");if(void 0===u[h.toString()]&&(u[h]={id:h,document_id:f}),s){getSection(m)}var v=o.shift();if(v.document_id!==f)throw errorDialog("Multi annotation error"),"multiAnnotation annotation id not found";annotationDatabaseId=v.id}else annotationDatabaseId=s?o.T.length>0?o.T.shift():o.A.shift():n[l];annoteSelectedText(!0),l++}d++,$("#myModal .bar").text(Math.round(l/a*100)+"%"),$("#myModal .bar").width(Math.round(l/a*100)+"%"),r.collapse(!1)}else clearInterval(c),$("#myModal .bar").width("100%"),$("#myModal .bar").text(""),$("#myModal").parent().addClass("progress-striped"),isMultidocument?multisaveDocuments(u,function(){$("#myModal").modal("hide"),i.stop(),cancelSelection(),r.collapse(!1),$("#annotateButton").prop("disabled",!0),$("#query").prop("disabled",!1),$("#query").val(""),ocurrences=0,$("#findOcurrencesText span.label").hide(),ocupado=!1}):(i.stop(),$("#myModal").modal("hide"),cancelSelection(),r.collapse(!1),$("#annotateButton").prop("disabled",!0),$("#query").prop("disabled",!1),$("#query").val(""),$("#findOcurrencesText span.label").hide(),ocurrences=0,ocupado=!1)},timeOutInterval)}else i.stop(),errorDialog(t.message)}).fail(function(t,e,n){i.stop(),errorDialog("annotationsQuestions/addAnnotation/ "+e)})}function multiAnnotationValidations(t,e,n,a,o){if(isEnd)needWordDialog();else{var i=[];typesMap[t].Question.length>0?$.ajax({type:"GET",url:markyLoctaion+"annotationsQuestions/view/",data:{type_id:t,text:e}}).done(function(s){s.success?(s.selectedText=e,s.typeId=t,questionsDialog(s,function(){i=getAnswers(),isJavaActionEnabled?sendJob({operation:"automaticAnnotateTerm",type_id:t,term:e,answers:i}):multiAnnotateSelectedText(t,e,i,n,a,o)})):errorDialog(s.message)}).fail(function(t,e,n){errorDialog(e)}):$.ajax({type:"GET",url:markyLoctaion+"annotationsQuestions/getTypeOfSelection/",data:{selectedText:$.trim(e)}}).done(function(i){i.success?warningTypeDialog(t,i.lastAnnotation,function(){isJavaActionEnabled?sendJob({operation:"automaticAnnotateTerm",type_id:t,term:e}):multiAnnotateSelectedText(t,e,[],n,a,o)}):errorDialog(i.message)})}}function clearTexts(){highlighter.highlightSelection(annotationTemporallyClass,{exclusive:!0}),null!==savedSel&&rangy.removeMarkers(savedSel),highlighter.removeAllHighlights(),cancelSelection()}function beforeSaveDocuments(t){return(t=t.clone()).find(".showRelation").removeClass("showRelation"),t}function multisaveDocuments(t,e){if(isMultidocument&&t.length>0){isCorpusModify=!1,$(".searchResult").each(function(){$(this).contents().unwrap()});for(var n in t){var a=$("#"+n).clone();a.find("span."+searchClass).each(function(){$(this).contents().unwrap()}),a.find("span."+searchPosibleWords).each(function(){$(this).contents().unwrap()}),a=beforeSaveDocuments(a),t[n].text_marked=a.html()}t=t.filter(function(t){return void 0!=t}),$.ajax({type:"POST",url:markyLoctaion+controller+"/saveAjax/",data:{documents:t}}).done(function(t){if(t.success)void 0!==e&&e();else{errorDialog(t.message,function(){location.reload()})}}).fail(function(t,e,n){errorDialog("multidocument"+e,function(){location.reload()})}),delete t}else void 0!==e&&e(),noSave()}function highlightPosibleWords(){if("undefined"!=typeof Storage){var t=localStorage.annotatedWords;if(void 0!==t&&void 0!==(t=JSON.parse(t))[round_id]){var e=t[round_id];searchPosibleWords=rangy.createClassApplier(searchPosibleClass);var n=rangy.createRange();n.selectNodeContents($("#documentBody").get(0));var a=e.length,o=0,i="",s=window.setInterval(function(){console.log(a),o<a?(i=e[o],highlightInterval=window.setInterval(function(){console.log(n.findText(i,searchPosibleWords)),n.findText(i,searchPosibleWords)?(n.select(),existOverlaping()||searchPosibleWords.applyToRange(n),console.log("dsf"),n.collapse(!1)):clearInterval(800)},800),o++):clearInterval(s)},800)}}}function highlightWork(t,e,n){console.log(n.findText(t,e)),n.findText(t,e)&&(n.select(),existOverlaping()||e.applyToRange(n),console.log("dsf"),n.collapse(!1))}function addPosibleWords(t){if("undefined"!=typeof Storage){var e=localStorage.annotatedWords,n=[];void 0===e?(e={})[round_id]=[]:void 0===e[round_id]?e[round_id]=[]:n=(e=JSON.parse(e))[round_id],-1===n.indexOf(t)&&(n.push(t),n.sort(function(t,e){return e.length-t.length}),e[round_id]=n,localStorage.annotatedWords=JSON.stringify(e))}}function toggleItalicYellowBg(){searchResultApplier.toggleSelection()}function getAntecesor(t){var e=t.commonAncestorContainer;return 3===e.nodeType&&(e=e.parentNode),e}function documentSelector(){-1!=lastPosition&&$("#documentSelector").val(lastPosition),$("#documentSelector").chosen(),$("#documentSelector").change(function(){var t=$("#documentSelector option:selected").attr("value");jumpToDocument($("#documentSelector option:selected").attr("data-document-id"),t)})}function jumpToAnnotation(t){var e=$("#search-pagination"),n=e.find("span.position"),a=n.text();a=parseInt(a),void 0!==t?t.hasClass("next")?a<annotationsFound.length&&a++:t.hasClass("prev")&&a>1&&a--:annotationsFound.length>0&&(a=1);var o=annotationsFound[a-1];a>1&&a<totalOcurrencesFound?(e.find("li.prev").removeClass("disabled"),e.find("li.next").removeClass("disabled"),n.text(a)):1==a?(e.find("li.prev").addClass("disabled"),n.text(1)):a==annotationsFound.length&&(e.find("li.next").addClass("disabled"),n.text(annotationsFound.length)),pulsedAnnotation='mark[data-id="'+o.Annotation.id+'"]';var i=o.Annotation.document_id;jumpToDocument(i,documentsMap[i])}function jumpToDocument(t,e){var n=$("#findMode").attr("value"),a=$("#page").val();if(lastPosition=e,n&&(n=1),e++,isCorpusModify)paginationAjax||saveDialog(),$("form#roundSave").submit();else if(paginationAjax){if(isMultidocument){var o=0;if(e%documentsPerPage>0&&o++,(e=Math.floor(e/documentsPerPage)+o)!=a)getPageAjax($("#canonical").attr("href")+"/page:"+e,t);else{var i=$("a[name='"+t+"']");$("#jumpTo").popover("hide"),jumpToOpen=!1,$("#findAnnotation").popover("hide"),findAnnotation=!1,scrollToElement(i)}}else getPageAjax($("#canonical").attr("href")+"/page:"+e);$("#page").val(e).change()}else window.location.replace($("#canonical").attr("href")+"/page:"+e)}function scrollToElement(t){$(".pulsar").removeClass("pulsar"),null!==pulsedAnnotation&&void 0!==pulsedAnnotation&&(pulsedAnnotation=t.parent().find(pulsedAnnotation)).addClass("pulsar"),pulsedAnnotation=null;var e=t.offset().top;if(t.hasClass("anchor")){var n=t.data("referer");console.log($("#"+n)),$("#"+n).addClass("backgroundAnimated")}$("html,body").animate({scrollTop:e},"slow")}function assessmentDialog(t){var e=$("#submitAssessment").attr("action"),n=$("#assessmentView").attr("href");if(isMultidocument){var a=t.attr("data-document-id"),o=n.lastIndexOf("/");-1!=o&&(n=n.substr(0,o+1)+a),$("#submitAssessment").find(".assement_document_id").val(a)}$("#submitAssessment button").on("mouseover",function(){var t=this;$("#submitAssessment button").each(function(){this!=t?$(this).tooltip("hide"):$(this).tooltip("show")})}),$.ajax({url:n,type:"get"}).done(function(t){if(isEnd){var e=$("#dialog-assessments").clone().attr("id","copyDialog");$.isEmptyObject(t.data.DocumentsAssessment)?e.find(".label-default").removeClass("hidden"):(t.data.DocumentsAssessment.positive>0?e.find(".label-success").removeClass("hidden"):t.data.DocumentsAssessment.neutral>0?e.find(".label-danger").removeClass("hidden"):t.data.DocumentsAssessment.negative>0&&e.find(".label-warning").removeClass("hidden"),e.find(".about_author").text(t.data.DocumentsAssessment.about_author),e.find(".topic").text(t.data.DocumentsAssessment.topic),e.find(".note").text(t.data.DocumentsAssessment.note)),e.modal({})}else $("#positive,#neutral,#negative").removeClass("active").prop("disabled",!1),t.success&&void 0!==t.data.DocumentsAssessment?(t.data.DocumentsAssessment.positive>0?($("#positive").attr("disabled","disabled").addClass("active"),$("#rate").val("positive")):t.data.DocumentsAssessment.neutral>0?($("#neutral").attr("disabled","disabled").addClass("active"),$("#rate").val("neutral")):t.data.DocumentsAssessment.negative>0&&($("#negative").attr("disabled","disabled").addClass("active"),$("#rate").val("negative")),$("#about_author").val(t.data.DocumentsAssessment.about_author),$("#topic").val(t.data.DocumentsAssessment.topic),$("#note").val(t.data.DocumentsAssessment.note),t.data.DocumentsAssessment.id&&$("#documentsAssessmentsId").val(t.data.DocumentsAssessment.id),$("#dialog-createAssessment").modal()):($("#about_author").val(""),$("#topic").val(""),$("#note").val(""),$("#rate").val(""),$("#documentsAssessmentsId").val("-1"),$("#dialog-createAssessment").modal())}).fail(function(t,e,n){errorDialog("annotationsQuestions/addAnnotation/ "+e)}),isEnd||($("#dialog-createAssessment div.modal-body button").click(function(){$("#dialog-createAssessment div.modal-body button").removeAttr("disabled").removeClass("active"),$(this).attr("disabled","disabled").addClass("active"),$("#rate").val($(this).attr("name"))}),$("#dialog-createAssessment .save").off("click").click(function(n){n.stopPropagation(),n.preventDefault(),$.ajax({url:e,type:"post",data:$("#submitAssessment").serialize()}).done(function(e){e.success?(t.addClass("used"),$("#dialog-createAssessment").modal("hide")):errorDialog(e.message)}).fail(function(t,e,n){errorDialog("annotationsQuestions/addAnnotation/ "+e)})}))}function notSupportDialog(){swal({title:"Ops!!",text:"Your browser does not support Marky!",type:"warning"})}function noSave(){console.error("There are not annotations to save"),swal({title:"Information!",text:"There are not annotations to save"})}function helpDialog(){isEnd?$("#helpDialog").modal():$("#helpDialog2").modal()}function returnDialog(t,e){var n=e||null;null!==n&&$(".return-content h4").text(n),$("#dialog-return").modal({backdrop:"static",keyboard:!1}),$("#dialog-return .ok").click(function(){$(this).hasClass("ok")&&(t?t():window.location=$("#comeBack").attr("href"))})}function saveDialog(){$("#dialog-save").modal({backdrop:"static",keyboard:!1})}function confirmDeleteDialog(t,e){e=e||$("#dialog-delete-confirm").text(),swal({title:"Are you sure?",text:e,type:"error",showCancelButton:!0,closeOnConfirm:!0,confirmButtonClass:"btn-danger",confirmButtonText:"Yes, delete it!"},function(){t()})}function confirmDialog(t,e){e=e||$("#dialog-confirm").text(),swal({title:"Are you sure?",text:e,type:"warning",showCancelButton:!0,closeOnConfirm:!0,confirmButtonClass:"btn-warning",confirmButtonText:"Yes, Im sure!"},function(){t()})}function errorDialog(t,e){swal({title:"Ops! one error occurs",text:t,type:"warning"},function(){void 0!==e?e():location.reload()})}function warnigAlertTypes(t){$("#dialog-form .alert").removeClass("hidden");for(var e=-1,n='<div class="alert alert-warning"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Note that this word has been previously annotated as ',a=t.length,o=0;o<a;o++)e=t[o],o==a-1&&0!=o&&(n+="and"),n+='<span class="label label-success" style="color:#000; margin:2px; background-color:'+colourMap[e]+'">'+typesMap[e].Type.name+"</span>";e=typeSelected.attr(typeAtribute),n+='. And now you are annotating it as <span class="label label-success" style="color:#000; margin:2px; background-color:'+colourMap[e]+'">'+typesMap[e].Type.name+"</span>",n+="</div>",$("#dialog-form .alert").html(n)}function warningTypeDialog(t,e,n){if(void 0!=e&&e.length>0&&-1===e.indexOf(parseInt(t))){for(var a=-1,o='<div class="alert alert-warning"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Note that this word has been previously annotated as ',i=e.length,s=0;s<i;s++)a=e[s],s==i-1&&0!=s&&(o+="and"),o+='<span class="label label-success" style="color:#000; margin:2px; background-color:'+colourMap[a]+'">'+typesMap[a].Type.name+"</span>";a=typeSelected.attr(typeAtribute),o+='. And now you are annotating it as <span class="label label-success" style="color:#000; margin:2px; background-color:'+colourMap[a]+'">'+typesMap[a].Type.name+"</span>",o+="</div>",swal({title:"Are you sure?",text:o,type:"warning",html:!0,cancelButtonText:"cancel",showCancelButton:!0,confirmButtonText:"Yes, annotate it!",confirmButtonClass:"btn-warning"},function(t){t&&void 0!==n?n():cancelSelection()})}else void 0!==n&&n()}function noOverlapsDialog(){cancelSelection(),swal({title:$("#dialog-annotationError").attr("title"),text:$("#dialog-annotationError").text(),type:"warning"})}function needWordDialog(){swal({title:"Information!",text:"You must enter a word in the text box :)"})}function noQuestionsDialog(){swal({title:$("#dialog-noQuestions").attr("title"),text:$("#dialog-noQuestions").text()})}function debugDialog(t){$("#myModal .modal-body").empty(),$("#myModal .modal-body").append(t)}function questionsDialog(t,e){var n=t.AnnotationsQuestion;n.length;t.lastAnnotation.length>0&&-1===t.lastAnnotation.indexOf(parseInt(t.typeId))?warnigAlertTypes(t.lastAnnotation):($("#dialog-form .loading-animation").addClass("hidden"),$("#dialog-form button").removeClass("hidden"),$("#dialog-form .modal-body").removeClass("hidden")),$("#dialog-form div.modal-body").empty(),$("#dialog-form button.save").unbind();var a,o,i,s,r=t.selectedText;for(o in n)void 0!==(a=n[o]).AnnotationsQuestion&&void 0!==a.AnnotationsQuestion.answer?(i=a.AnnotationsQuestion.answer,s=a.AnnotationsQuestion.id):(i=" ",s=-1),$("#dialog-form .modal-body").append(formInputsTemplate.format(a.Question.question,a.Question.question_id,s,i));$("#dialog-form").modal({backdrop:"static",keyboard:!1}),$(".answer").typeahead({minLength:0,showHintOnFocus:!0,source:function(t,e){$.ajax({type:"GET",url:markyLoctaion+"annotationsQuestions/getPrediction/",data:{q:t,selectedText:$.trim(r)}}).done(function(t){return e(t.lastAnswers)})}}),isEnd?($("#dialog-form button.save").remove(),$("#dialog-form .modal-body textArea").attr("disabled","disabled").addClass("disabled")):$("#dialog-form button").click(function(t){t.stopPropagation(),t.preventDefault(),$(this).hasClass("save")?($("#dialog-form .loading-animation").removeClass("hidden"),$("#dialog-form .modal-body").addClass("hidden"),$("#dialog-form button").addClass("hidden"),e()):(cancelSelection(),$("#dialog-form").modal("hide"))})}function reloadLocation(){var t=$("#page").attr("value"),e=$("#canonical").attr("href")+"/page:"+t;window.location.replace(e)}var allowNested=!0,highlighter,id=0,marks=null,idDate=null,typeSelected=null,savedSel=null,types=null,typesMap={},dialogForm=null,dialogLoading=null,endTime=!1,ocupado=!1,isEnd=null,isCorpusModify=!1,colourMap={},trim_helper=!1,whole_word_helper=!1,punctuation_helper=!1,typeAtribute="data-type-id",annotationDefaultClass="annotation",annotationHasAnswersClass="hasCommentary",automaticAnnotationClass="hasCommentary",annotationDefaultName="annotation",annotationTemporallyClass="selection",lastAnnotation=null,annotationDefaultKeyClass="MarkytClass",parsetKey="",parseAnnotationIdAttr="data-id",annotationTag="mark",annotationCount=0,annotationDatabaseId=0,isOffline=!1,annotationHasAnswers=!1,textContent="#textContent",creatingRelation=!1,elementA,elementB,autoSaveMinutes,round_id=-1,searchClass="searchResult",range,searchResultApplier,searchScopeRange,mutiAnnotateOptions={},timeOutInterval=200,formInputsTemplate="",markyLoctaion="",disableHelpers=!1,disableAnnotations=!1,paginationAjax=!1,isOpera=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,isFirefox="undefined"!=typeof InstallTrigger,isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,isChrome=!!window.chrome&&!isOpera,isIE=!!document.documentMode,diableReturnKey=!1,jumpToOpen=!1,findAnnotation=!1,editViewAnnotationTimeout=null,isMultidocument=!1,documentsPerPage,searchPosibleWords,searchPosibleClass="posibleAnnotation",controller="annotatedDocuments",lastPosition=-1,isChangedBar,isJavaActionEnabled,PID=-1,cancellingJob=!1,updateStateEnd=!0,searchingAnnotation=!1,annotationsFound=null,totalOcurrencesFound=0,documentsMap=null,pulsedAnnotation=null,lastPositionAction={url:window.location.href},undoActions=[];!function(t){t.fn.disableSelection=function(){return this.attr("unselectable","on").on("selectstart",!1).css({"-moz-user-select":"none","-o-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","user-select":"none"})},t.fn.hasAttr=function(t){return void 0!==this.attr(t)}}(jQuery),String.prototype.format||(String.prototype.format=function(){var t=arguments;return this.replace(/{(\d+)}/g,function(e,n){return void 0!==t[n]?t[n]:e})}),$(document).ready(function(){isEnd=$("#isEnd").attr("value"),isEnd="true"===isEnd,isChangedBar=$("#ischangedBar").attr("value"),(isChangedBar="true"===isChangedBar)&&topSidebar(),rangy.init();var t=rangy.modules.ClassApplier;if(rangy.supported&&t&&t.supported){range=rangy.createRange(),searchResultApplier=rangy.createClassApplier(searchClass),isMultidocument=JSON.parse($("#isMultiDocument").attr("value")),documentsPerPage=JSON.parse($("#documentsPerPage").attr("value")),isMultidocument&&(textContent=".textContent"),e=range.selectNodeContents($("#documentBody").get(0));var e=rangy.createRange();e.selectNodeContents($("#documentBody").get(0)),mutiAnnotateOptions={caseSensitive:!1,wholeWordsOnly:!0,withinRange:e,direction:"forward"},formInputsTemplate=$("#form-Template").html(),markyLoctaion=location.protocol+"//"+location.host+$("#hostPath").attr("href"),parseKey=$("#parseKey").val(),parseAnnotationIdAttr=$("#parseIdAttr").val();var n,a,o,i,s=JSON.parse($("#nonTypes").attr("value")),r="";for($("body").hide(),$("#affix-sidebar,#context-menu").disableSelection(),types=$("#types-list").attr("value"),types=JSON.parse(types),dialogForm=$("#dialog-form"),dialogConfirm=$("#dialog-confirm"),dialogLoading=$("#saving"),trim_helper=$("#trim_helper").attr("value"),whole_word_helper=$("#whole_word_helper").attr("value"),punctuation_helper=$("#punctuation_helper").attr("value"),paginationAjax=JSON.parse($("#annotationCorePaginationAjax").attr("value")),round_id=$("#round_id").attr("value"),isJavaActionEnabled=JSON.parse($("#enableJavaActions").attr("value")),$("#documentsMap").length>0?documentsMap=JSON.parse($("#documentsMap").attr("value")):console.error("No documents map"),$("#page").change(function(){lastPositionAction.page=$(this).val(),delete lastPositionAction.document,localStorage.setItem("lastPositionAction",JSON.stringify(lastPositionAction))}),$("#toUpBar,#toLeftBar").click(function(){isCorpusModify&&!isEnd?(event.preventDefault(),returnDialog(function(){$.ajax({type:"GET",url:markyLoctaion+controller+"/changeNabPosition/"}).done(function(){location.reload()}).fail(function(){errorDialog("Nav colud not be changed")})},"You have changed this round, are sure you want to continue without saving?(Unsaved annotations will be lost)")):$.ajax({type:"GET",url:markyLoctaion+controller+"/changeNabPosition/"}).done(function(){location.reload()}).fail(function(){errorDialog("Nav colud not be changed")})}),isEnd?$(textContent).css("cursor","auto"):($("#disableHelper").click(function(){disableHelpers?(disableHelpers=!1,$(this).removeClass("active"),$(this).blur()):($(this).addClass("active"),disableHelpers=!0)}),$("#disableAnnotations").click(function(){disableAnnotations?(disableAnnotations=!1,$(this).removeClass("active"),$(this).blur(),void 0!==sessionStorage.typeSelected?$(sessionStorage.typeSelected).click():$(".types-annotations button").first().click(),document.oncontextmenu=function(){return!1}):(document.oncontextmenu=function(){return!0},$(this).addClass("active"),disableAnnotations=!0,jss.remove())})),$("#helpButton").click(function(){helpDialog()}),$("#restoreLastSave").click(function(){var t=$("#page").attr("value");paginationAjax?getPageAjax($("#canonical").attr("href")+"/page:"+t):location.reload()}),document.oncontextmenu=function(){return!1},initialiceId(),highlighter=rangy.createHighlighter(),o=types.length,a=0;a<o;a++)r+=createDinamicCSS((i=types[a]).Type.id,i.Type.colour),typesMap[i.Type.id]=i,colourMap[i.Type.id]="rgba("+i.Type.colour+")";createRangyCSS(annotationTemporallyClass);for(var l in s){var d=classGenerator(l);removeAnnotations($(annotationTag+"."+d))}if($("<style>").prop("type","text/css").html(r).appendTo("head"),initializeAnnotations(),isEnd||($(".rangySelectionBoundary").remove(),$(".types-annotations button").removeAttr("disabled"),$(".types-annotations button").click(function(){typeSelected=$(this),changeSelectColor($(this).attr(typeAtribute)),$(".types-annotations button").removeAttr("disabled"),$(this).attr("disabled","disabled"),sessionStorage.typeSelected="#"+$(this).attr("id")}),changeSelectColor(void 0===sessionStorage.typeSelected?(typeSelected=$(".types-annotations button").first().attr("disabled","disabled")).attr(typeAtribute):(typeSelected=$(sessionStorage.typeSelected).first().attr("disabled","disabled")).attr(typeAtribute)),null==typeSelected&&changeSelectColor((typeSelected=$(".types-annotations button").first().attr("disabled","disabled")).attr(typeAtribute)),$("#roundSave").submit(function(t){$("span."+searchClass).each(function(){$(this).contents().unwrap()}),isCorpusModify&&($("span."+searchClass).each(function(){$(this).contents().unwrap()}),n=$(textContent).html(),$("#textToSave").attr("value",n)),paginationAjax?(t.preventDefault(),$("#overlay").modal(),$.ajax({type:"POST",url:$(this).attr("action"),data:$(this).serialize(),success:function(t){updatePageAjax(t)},error:function(t,e,n){errorDialog(n)}})):saveDialog()}),"null"===(autoSaveMinutes=$("#autoSaveMinutes").val())&&(autoSaveMinutes=3),autoSaveMinutes*=60,isMultidocument?($("#restoreLastSave").parent().addClass("hidden"),$("#save").addClass("hidden")):$("#counterDesc").countdown({until:+autoSaveMinutes,format:"MS",onExpiry:timerLiftOff,compact:!0,description:"Autosave",onTick:timeEvents}),multiselection()),$("#assessmentButton").click(function(){assessmentDialog($(this))}),$("#documentBody").on("click",".rate-document",function(t){assessmentDialog($(this))}),isMultidocument){var c="left",u="#popoversContainer";isChangedBar&&(c="left",u="#markyTopNavBar"),$("#jumpTo").popover({html:!0,placement:c,container:u,content:function(){var t=$("#projectDocuments").clone().find(".documentSelector").attr("id","documentSelector");if($("#documentSelector").length<2)return t}}).click(function(t){$("#findAnnotation").popover("hide"),jumpToOpen?($("#jumpTo").popover("hide"),jumpToOpen=!1):($("#jumpTo").blur(),$("#jumpTo").popover("show"),documentSelector(),jumpToOpen=!0)}).on("show.bs.popover",function(){$(this).data("bs.popover").tip().css("min-width","400px"),$(".tooltip ").remove()}),$("#findAnnotation").popover({html:!0,placement:c,container:u,content:function(){if(0==$("#findAnnotationContainer").length){if(searchingAnnotation)var t=$(".searchingAnimation").html();else(t=$(".annotationFind").clone()).removeClass("hidden").attr("id","findAnnotationContainer"),t.find("a").click(function(t){t.preventDefault();var e=$(this).text();$(".search-panel span.search_concept").text(e);var n=$(this).attr("data-type-id");$(".input-group .type_id").val(n)});return t}return $("#findAnnotationContainer")}}).click(function(t){$("#jumpTo").popover("hide"),jumpToOpen=!1,findAnnotation?($("#findAnnotation").popover("hide"),findAnnotation=!1):($("#findAnnotation").blur(),$("#findAnnotation").popover("show"),findAnnotation=!0)}).on("show.bs.popover",function(){$(this).data("bs.popover").tip().css("min-width","400px"),setTimeout(function(){$("#findAnnotationContainer input.query").focus()},500),$(".tooltip ").remove()}),$(u).on("submit","form.annotationFindForm",function(t){return t.preventDefault(),searchingAnnotation=!0,$("#findAnnotationContainer").html($(".searchingAnimation").html()),$.sticky.dequeue(),$.ajax({type:"GET",url:$(this).attr("action"),data:$(this).serialize()}).done(function(t){if(searchingAnnotation=!1,$(".popover").popover("hide"),t.success){var e=t.ocurrences,n=t.query,a=$(".annotationFind>div.searchPagination").clone(),o=!1;annotationsFound=t.annotations,totalOcurrencesFound=e,0==e?(a.find("li").addClass("disabled"),o=1e4):(a.find(".position").html("1"),a.find(".prev").addClass("disabled"),a.find(".total").html(annotationsFound.length)),annotationsFound.length>0&&jumpToAnnotation(),setTimeout(function(){$.sticky({icon:'<i class="fa fa-search fa-2"></i>',iconType:"i",title:e+" ocurrences of "+n+"!",animations:{"bottom-right":["slideInUp","slideOutDown"]},body:"<div id='search-pagination'>"+a.html()+"</div>",position:"bottom-right",useAnimateCss:!0,hideAfter:o,closeable:!0})},500)}else errorDialog(t.message,function(){location.reload()})}).fail(function(t,e,n){errorDialog(e),debugDialog(t)}),!1}),$("body").on("click","#search-pagination li.prev,#search-pagination li.next",function(t){t.preventDefault(),jumpToAnnotation($(this))})}else $("#projectDocuments").find(".documentSelector").attr("id","documentSelector"),documentSelector();$("body").on("click",".pagination a",function(t){var e,n=$(this).attr("href");if(void 0!==n){var a=n.indexOf(":");e=-1===a?1:n.substring(a+1),e--,$("#page").val(e).change(),isCorpusModify&&!isEnd?(t.preventDefault(),$("form#roundSave").submit()):(t.preventDefault(),getPageAjax($(this).attr("href")))}}),$("body").on("change","select.page-selector",function(t){var e,n=$(this).data("url");if(void 0!==n){console.log(n);var a,o=n.indexOf("/page:");a=-1===o?n:n.substring(0,o+1),e=$(this).val(),$("#page").val(e).change(),isCorpusModify&&!isEnd?(t.preventDefault(),$("form#roundSave").submit()):(t.preventDefault(),"/"!=a.slice(-1)&&(a+="/"),getPageAjax(a+"page:"+e))}}),$("#comeBack").click(function(t){isCorpusModify&&!isEnd&&(t.preventDefault(),returnDialog())}),$(document).keydown(function(t){if(90===t.which&&t.ctrlKey){if(undoActions.length>0){var e=undoActions.pop();switch(e.type){case"createAnnotation":(a=(n=e.element).closest(textContent)).attr("data-document-id");o="#"+a.attr("data-document-annotated-id");n.addClass("toRemove"),$(o).length>0&&$("html,body").animate({scrollTop:$(o).offset().top-250}).promise().done(function(){setTimeout(function(){removeAnnotations([n])},200)});break;case"createRelation":var n=e.elementA,a=n.closest(textContent),o=(a.attr("data-document-id"),"#"+a.attr("data-document-annotated-id"));e.elementA.addClass("toRemove"),e.elementB.addClass("toRemove"),$(o).length>0&&$("html,body").animate({scrollTop:$(o).offset().top-250}).promise().done(function(){setTimeout(function(){removeInterelation(e.elementA,e.elementB,e.interRelationId),e.elementA.removeClass("toRemove"),e.elementB.removeClass("toRemove")},200)})}}}else if(!$("input,textarea").is(":focus"))if(8===t.keyCode){if(isCorpusModify&&!isEnd&&(t.preventDefault(),returnDialog()),diableReturnKey)return!1}else 18===t.keyCode?$("#disableAnnotations").click():16===t.keyCode?$("#disableHelper").click():27===t.keyCode&&(creatingRelation=!1,elementA=null,elementB=null,endLinkMode())}),$("#content").mousedown(function(t){inRelationMode&&2===t.button&&(creatingRelation=!1,elementA=null,elementB=null,endLinkMode())}),$("#printButton").css({cursor:"wait"}),$("body").show(),$("body").css({display:"true"}),$("#types").animate({scrollTop:$("#types").height()},"slow"),$("#documentBody").on("mouseup",textContent,function(t){1==t.which&&addAnnotation(t)}),$("mark.automatic").tooltip({container:"body",title:"Automatic annotation"}),responsiveFunctions()}else notSupportDialog()}),$(window).resize(function(){responsiveFunctions()}),$(window).load(function(){$("body").show(),createRelation(515676,515681),$("body").css({display:"true"}),$("#printButton").css({cursor:"pointer"}),$("#printButton").click(function(){$("#affix-sidebar").hide(),$("#back-to-top").hide(),$("#verticalButtons").hide(),window.print(),$("#affix-sidebar").show(),$("#back-to-top").show(),$("#verticalButtons").show()})}),$(document).ajaxStart(function(){});var highlightInterval;