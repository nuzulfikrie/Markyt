(function(b,a){if(typeof define=="function"&&define.amd){define(["./rangy-core"],b)}else{if(typeof module!="undefined"&&typeof exports=="object"){module.exports=b(require("rangy"))}else{b(a.rangy)}}})(function(a){a.createModule("ClassApplier",["WrappedSelection"],function(k,h){var d=k.dom;var w=d.DomPosition;var F=d.arrayContains;var c=k.util.forEach;var G="span";var q=k.util.isHostMethod(document,"createElementNS");function U(ad,ac){for(var ab in ad){if(ad.hasOwnProperty(ab)){if(ac(ab,ad[ab])===false){return false}}}return true}function b(ab){return ab.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function Y(ab,ac){return !!ab&&new RegExp("(?:^|\\s)"+ac+"(?:\\s|$)").test(ab)}function Q(ac,ab){if(typeof ac.classList=="object"){return ac.classList.contains(ab)}else{var ae=(typeof ac.className=="string");var ad=ae?ac.className:ac.getAttribute("class");return Y(ad,ab)}}function z(ac,ab){if(typeof ac.classList=="object"){ac.classList.add(ab)}else{var ae=(typeof ac.className=="string");var ad=ae?ac.className:ac.getAttribute("class");if(ad){if(!Y(ad,ab)){ad+=" "+ab}}else{ad=ab}if(ae){ac.className=ad}else{ac.setAttribute("class",ad)}}}var s=(function(){function ab(ac,ae,ad){return(ae&&ad)?" ":""}return function(ad,ac){if(typeof ad.classList=="object"){ad.classList.remove(ac)}else{var af=(typeof ad.className=="string");var ae=af?ad.className:ad.getAttribute("class");ae=ae.replace(new RegExp("(^|\\s)"+ac+"(\\s|$)"),ab);if(af){ad.className=ae}else{ad.setAttribute("class",ae)}}}})();function m(ab){var ac=(typeof ab.className=="string");return ac?ab.className:ab.getAttribute("class")}function C(ab){return ab&&ab.split(/\s+/).sort().join(" ")}function A(ab){return C(m(ab))}function r(ac,ab){return A(ac)==A(ab)}function y(af,ae){var ad=ae.split(/\s+/);for(var ac=0,ab=ad.length;ac<ab;++ac){if(!Q(af,b(ad[ac]))){return false}}return true}function S(ac){var ab=ac.parentNode;return(ab&&ab.nodeType==1&&!/^(textarea|style|script|select|iframe)$/i.test(ab.nodeName))}function aa(ad,ag,af,aj,ai){var ab=ad.node,ac=ad.offset;var ah=ab,ae=ac;if(ab==aj&&ac>ai){++ae}if(ab==ag&&(ac==af||ac==af+1)){ah=aj;ae+=ai-af}if(ab==ag&&ac>af+1){--ae}ad.node=ah;ad.offset=ae}function n(ac,ab,ad){if(ac.node==ab&&ac.offset>ad){--ac.offset}}function o(af,ae,ad,ab){if(ad==-1){ad=ae.childNodes.length}var ac=af.parentNode;var ag=d.getNodeIndex(af);c(ab,function(ah){aa(ah,ac,ag,ae,ad)});if(ae.childNodes.length==ad){ae.appendChild(af)}else{ae.insertBefore(af,ae.childNodes[ad])}}function K(ad,ab){var ac=ad.parentNode;var ae=d.getNodeIndex(ad);c(ab,function(af){n(af,ac,ae)});d.removeNode(ad)}function P(af,ae,ad,ag,ab){var ah,ac=[];while((ah=af.firstChild)){o(ah,ae,ad++,ab);ac.push(ah)}if(ag){K(af,ab)}return ac}function M(ac,ab){return P(ac,ac.parentNode,d.getNodeIndex(ac),true,ab)}function D(ab,af){var ac=ab.cloneRange();ac.selectNodeContents(af);var ad=ac.intersection(ab);var ae=ad?ad.toString():"";return ae!=""}function J(ad){var ac=ad.getNodes([3]);var af=0,ae;while((ae=ac[af])&&!D(ad,ae)){++af}var ab=ac.length-1;while((ae=ac[ab])&&!D(ad,ae)){--ab}return ac.slice(af,ab+1)}function W(ah,af){if(ah.attributes.length!=af.attributes.length){return false}for(var ag=0,ab=ah.attributes.length,ae,ac,ad;ag<ab;++ag){ae=ah.attributes[ag];ad=ae.name;if(ad!="class"){ac=af.attributes.getNamedItem(ad);if((ae===null)!=(ac===null)){return false}if(ae.specified!=ac.specified){return false}if(ae.specified&&ae.nodeValue!==ac.nodeValue){return false}}}return true}function X(af,ae){for(var ad=0,ab=af.attributes.length,ac;ad<ab;++ad){ac=af.attributes[ad].name;if(!(ae&&F(ae,ac))&&af.attributes[ad].specified&&ac!="class"){return true}}return false}var t=d.getComputedStyleProperty;var v=(function(){var ab=document.createElement("div");return typeof ab.isContentEditable=="boolean"?function(ac){return ac&&ac.nodeType==1&&ac.isContentEditable}:function(ac){if(!ac||ac.nodeType!=1||ac.contentEditable=="false"){return false}return ac.contentEditable=="true"||v(ac.parentNode)}})();function g(ac){var ab;return ac&&ac.nodeType==1&&(((ab=ac.parentNode)&&ab.nodeType==9&&ab.designMode=="on")||(v(ac)&&!v(ac.parentNode)))}function f(ab){return(v(ab)||(ab.nodeType!=1&&v(ab.parentNode)))&&!g(ab)}var T=/^inline(-block|-table)?$/i;function j(ab){return ab&&ab.nodeType==1&&!T.test(t(ab,"display"))}var l=/[^\r\n\t\f \u200B]/;function O(ab){if(ab.data.length==0){return true}if(l.test(ab.data)){return false}var ac=t(ab.parentNode,"whiteSpace");switch(ac){case"pre":case"pre-wrap":case"-moz-pre-wrap":return false;case"pre-line":if(/[\r\n]/.test(ab.data)){return false}}return j(ab.previousSibling)||j(ab.nextSibling)}function N(ac){var ab=[],ae,ad;for(ae=0;ad=ac[ae++];){ab.push(new w(ad.startContainer,ad.startOffset),new w(ad.endContainer,ad.endOffset))}return ab}function V(ae,ad){for(var ag=0,af,ah,ac,ab=ae.length;ag<ab;++ag){af=ae[ag];ah=ad[ag*2];ac=ad[ag*2+1];af.setStartAndEnd(ah.node,ah.offset,ac.node,ac.offset)}}function H(ab,ac){if(d.isCharacterDataNode(ab)){if(ac==0){return !!ab.previousSibling}else{if(ac==ab.length){return !!ab.nextSibling}else{return true}}}return ac>0&&ac<ab.childNodes.length}function R(af,ak,ac,ai){var al,aj;var ad=(ac==0);if(d.isAncestorOf(ak,af)){return af}if(d.isCharacterDataNode(ak)){var ag=d.getNodeIndex(ak);if(ac==0){ac=ag}else{if(ac==ak.length){ac=ag+1}else{throw h.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+ac+" in "+ak.data)}}ak=ak.parentNode}if(H(ak,ac)){al=ak.cloneNode(false);aj=ak.parentNode;if(al.id){al.removeAttribute("id")}var ab,ah=0;while((ab=ak.childNodes[ac])){o(ab,al,ah++,ai)}o(al,aj,d.getNodeIndex(ak)+1,ai);return(ak==af)?al:R(af,aj,d.getNodeIndex(al),ai)}else{if(af!=ak){al=ak.parentNode;var ae=d.getNodeIndex(ak);if(!ad){ae++}return R(af,al,ae,ai)}}return af}function Z(ac,ab){return ac.namespaceURI==ab.namespaceURI&&ac.tagName.toLowerCase()==ab.tagName.toLowerCase()&&r(ac,ab)&&W(ac,ab)&&t(ac,"display")=="inline"&&t(ab,"display")=="inline"}function u(ab){var ac=ab?"nextSibling":"previousSibling";return function(ah,ae){var af=ah.parentNode;var ag=ah[ac];if(ag){if(ag&&ag.nodeType==3){return ag}}else{if(ae){ag=af[ac];if(ag&&ag.nodeType==1&&Z(af,ag)){var ad=ag[ab?"firstChild":"lastChild"];if(ad&&ad.nodeType==3){return ad}}}}return null}}var x=u(false),p=u(true);function B(ac){this.isElementMerge=(ac.nodeType==1);this.textNodes=[];var ab=this.isElementMerge?ac.lastChild:ac;if(ab){this.textNodes[0]=ab}}B.prototype={doMerge:function(ab){var ah=this.textNodes;var ag=ah[0];if(ah.length>1){var ae=d.getNodeIndex(ag);var ac=[],ad=0,ai,af;c(ah,function(ak,aj){af=ak.parentNode;if(aj>0){af.removeChild(ak);if(!af.hasChildNodes()){d.removeNode(af)}if(ab){c(ab,function(al){if(al.node==ak){al.node=ag;al.offset+=ad}if(al.node==af&&al.offset>ae){--al.offset;if(al.offset==ae+1&&aj<len-1){al.node=ag;al.offset=ad}}})}}ac[aj]=ak.data;ad+=ak.data.length});ag.data=ac.join("")}return ag.data},getLength:function(){var ac=this.textNodes.length,ab=0;while(ac--){ab+=this.textNodes[ac].length}return ab},toString:function(){var ab=[];c(this.textNodes,function(ad,ac){ab[ac]="'"+ad.data+"'"});return"[Merge("+ab.join(",")+")]"}};var E=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements","onElementCreate"];var e={};function I(ai,am,al){var af,ae,ah,ag,ak=this;ak.cssClass=ak.className=ai;var ad=null,ac={};if(typeof am=="object"&&am!==null){if(typeof am.elementTagName!=="undefined"){am.elementTagName=am.elementTagName.toLowerCase()}al=am.tagNames;ad=am.elementProperties;ac=am.elementAttributes;for(ae=0;ag=E[ae++];){if(am.hasOwnProperty(ag)){ak[ag]=am[ag]}}af=am.normalize}else{af=am}ak.normalize=(typeof af=="undefined")?true:af;ak.attrExceptions=[];var ab=document.createElement(ak.elementTagName);ak.elementProperties=ak.copyPropertiesToElement(ad,ab,true);U(ac,function(an){ak.attrExceptions.push(an)});ak.elementAttributes=ac;ak.elementSortedClassName=ak.elementProperties.hasOwnProperty("className")?C(ak.elementProperties.className+" "+ai):ai;ak.applyToAnyTagName=false;var aj=typeof al;if(aj=="string"){if(al=="*"){ak.applyToAnyTagName=true}else{ak.tagNames=b(al.toLowerCase()).split(/\s*,\s*/)}}else{if(aj=="object"&&typeof al.length=="number"){ak.tagNames=[];for(ae=0,ah=al.length;ae<ah;++ae){if(al[ae]=="*"){ak.applyToAnyTagName=true}else{ak.tagNames.push(al[ae].toLowerCase())}}}else{ak.tagNames=[ak.elementTagName]}}}I.prototype={elementTagName:G,elementProperties:{},elementAttributes:{},ignoreWhiteSpace:true,applyToEditableOnly:false,useExistingElements:true,removeEmptyElements:true,onElementCreate:null,copyPropertiesToElement:function(ai,ad,aj){var al,ak,ag={},af,ac,ae,ah;for(var ab in ai){if(ai.hasOwnProperty(ab)){ac=ai[ab];ae=ad[ab];if(ab=="className"){z(ad,ac);z(ad,this.className);ad[ab]=C(ad[ab]);if(aj){ag[ab]=ac}}else{if(ab=="style"){ak=ae;if(aj){ag[ab]=af={}}for(al in ai[ab]){if(ai[ab].hasOwnProperty(al)){ak[al]=ac[al];if(aj){af[al]=ak[al]}}}this.attrExceptions.push(ab)}else{ad[ab]=ac;if(aj){ag[ab]=ad[ab];ah=e.hasOwnProperty(ab)?e[ab]:ab;this.attrExceptions.push(ah)}}}}}return aj?ag:""},copyAttributesToElement:function(ab,ad){for(var ac in ab){if(ab.hasOwnProperty(ac)&&!/^class(?:Name)?$/i.test(ac)){ad.setAttribute(ac,ab[ac])}}},appliesToElement:function(ab){return F(this.tagNames,ab.tagName.toLowerCase())},getEmptyElements:function(ab){var ac=this;return ab.getNodes([1],function(ad){return ac.appliesToElement(ad)&&!ad.hasChildNodes()})},hasClass:function(ab){return ab.nodeType==1&&(this.applyToAnyTagName||this.appliesToElement(ab))&&Q(ab,this.className)},getSelfOrAncestorWithClass:function(ab){while(ab){if(this.hasClass(ab)){return ab}ab=ab.parentNode}return null},isModifiable:function(ab){return !this.applyToEditableOnly||f(ab)},isIgnorableWhiteSpaceNode:function(ab){return this.ignoreWhiteSpace&&ab&&ab.nodeType==3&&O(ab)},postApply:function(an,ak,ai,ag){var ab=an[0],ac=an[an.length-1];var ae=[],ao;var ah=ab,ad=ac;var al=0,ap=ac.length;var af,aj;c(an,function(aq){aj=x(aq,!ag);if(aj){if(!ao){ao=new B(aj);ae.push(ao)}ao.textNodes.push(aq);if(aq===ab){ah=ao.textNodes[0];al=ah.length}if(aq===ac){ad=ao.textNodes[0];ap=ao.getLength()}}else{ao=null}});var am=p(ac,!ag);if(am){if(!ao){ao=new B(ac);ae.push(ao)}ao.textNodes.push(am)}if(ae.length){for(i=0,len=ae.length;i<len;++i){ae[i].doMerge(ai)}ak.setStartAndEnd(ah,al,ad,ap)}},createContainer:function(ab){var ae=d.getDocument(ab);var ad;var ac=q&&!d.isHtmlNamespace(ab)&&(ad=ab.namespaceURI)?ae.createElementNS(ab.namespaceURI,this.elementTagName):ae.createElement(this.elementTagName);this.copyPropertiesToElement(this.elementProperties,ac,false);this.copyAttributesToElement(this.elementAttributes,ac);z(ac,this.className);if(this.onElementCreate){this.onElementCreate(ac,this)}return ac},elementHasProperties:function(ad,ac){var ab=this;return U(ac,function(ae,af){if(ae=="className"){return y(ad,af)}else{if(typeof af=="object"){if(!ab.elementHasProperties(ad[ae],af)){return false}}else{if(ad[ae]!==af){return false}}}})},elementHasAttributes:function(ac,ab){return U(ab,function(ad,ae){if(ac.getAttribute(ad)!==ae){return false}})},applyToTextNode:function(af,ab){if(S(af)){var ad=af.parentNode;if(ad.childNodes.length==1&&this.useExistingElements&&this.appliesToElement(ad)&&this.elementHasProperties(ad,this.elementProperties)&&this.elementHasAttributes(ad,this.elementAttributes)){z(ad,this.className)}else{var ae=af.parentNode;var ac=this.createContainer(ae);ae.insertBefore(ac,af);ac.appendChild(af)}}},isRemovable:function(ab){return ab.tagName.toLowerCase()==this.elementTagName&&A(ab)==this.elementSortedClassName&&this.elementHasProperties(ab,this.elementProperties)&&!X(ab,this.attrExceptions)&&this.elementHasAttributes(ab,this.elementAttributes)&&this.isModifiable(ab)},isEmptyContainer:function(ab){var ac=ab.childNodes.length;return ab.nodeType==1&&this.isRemovable(ab)&&(ac==0||(ac==1&&this.isEmptyContainer(ab.firstChild)))},removeEmptyContainers:function(ad){var ae=this;var ac=ad.getNodes([1],function(ag){return ae.isEmptyContainer(ag)});var af=[ad];var ab=N(af);c(ac,function(ag){K(ag,ab)});V(af,ab)},undoToTextNode:function(af,ad,ae,ac){if(!ad.containsNode(ae)){var ab=ad.cloneRange();ab.selectNode(ae);if(ab.isPointInRange(ad.endContainer,ad.endOffset)){R(ae,ad.endContainer,ad.endOffset,ac);ad.setEndAfter(ae)}if(ab.isPointInRange(ad.startContainer,ad.startOffset)){ae=R(ae,ad.startContainer,ad.startOffset,ac)}}if(this.isRemovable(ae)){M(ae,ac)}else{s(ae,this.className)}},splitAncestorWithClass:function(ac,ae,ab){var ad=this.getSelfOrAncestorWithClass(ac);if(ad){R(ad,ac,ae,ab)}},undoToAncestor:function(ac,ab){if(this.isRemovable(ac)){M(ac,ab)}else{s(ac,this.className)}},applyToRange:function(ad,ah){var ae=this;ah=ah||[];var ac=N(ah||[]);ad.splitBoundariesPreservingPositions(ac);if(ae.removeEmptyElements){ae.removeEmptyContainers(ad)}var ag=J(ad);if(ag.length){c(ag,function(ai){if(!ae.isIgnorableWhiteSpaceNode(ai)&&!ae.getSelfOrAncestorWithClass(ai)&&ae.isModifiable(ai)){ae.applyToTextNode(ai,ac)}});var ab=ag[ag.length-1];ad.setStartAndEnd(ag[0],0,ab,ab.length);if(ae.normalize){ae.postApply(ag,ad,ac,false)}V(ah,ac)}var af=ae.getEmptyElements(ad);c(af,function(ai){z(ai,ae.className)})},applyToRanges:function(ab){var ac=ab.length;while(ac--){this.applyToRange(ab[ac],ab)}return ab},applyToSelection:function(ac){var ab=k.getSelection(ac);ab.setRanges(this.applyToRanges(ab.getAllRanges()))},undoToRange:function(af,aj){var al=this;aj=aj||[];var ad=N(aj);af.splitBoundariesPreservingPositions(ad);if(al.removeEmptyElements){al.removeEmptyContainers(af,ad)}var ah=J(af);var ab,ac;var ai=ah[ah.length-1];if(ah.length){al.splitAncestorWithClass(af.endContainer,af.endOffset,ad);al.splitAncestorWithClass(af.startContainer,af.startOffset,ad);for(var ae=0,ag=ah.length;ae<ag;++ae){ab=ah[ae];ac=al.getSelfOrAncestorWithClass(ab);if(ac&&al.isModifiable(ab)){al.undoToAncestor(ac,ad)}}af.setStartAndEnd(ah[0],0,ai,ai.length);if(al.normalize){al.postApply(ah,af,ad,true)}V(aj,ad)}var ak=al.getEmptyElements(af);c(ak,function(am){s(am,al.className)})},undoToRanges:function(ab){var ac=ab.length;while(ac--){this.undoToRange(ab[ac],ab)}return ab},undoToSelection:function(ad){var ac=k.getSelection(ad);var ab=k.getSelection(ad).getAllRanges();this.undoToRanges(ab);ac.setRanges(ab)},isAppliedToRange:function(ab){if(ab.collapsed||ab.toString()==""){return !!this.getSelfOrAncestorWithClass(ab.commonAncestorContainer)}else{var ad=ab.getNodes([3]);if(ad.length){for(var ac=0,ae;ae=ad[ac++];){if(!this.isIgnorableWhiteSpaceNode(ae)&&D(ab,ae)&&this.isModifiable(ae)&&!this.getSelfOrAncestorWithClass(ae)){return false}}}return true}},isAppliedToRanges:function(ab){var ac=ab.length;if(ac==0){return false}while(ac--){if(!this.isAppliedToRange(ab[ac])){return false}}return true},isAppliedToSelection:function(ac){var ab=k.getSelection(ac);return this.isAppliedToRanges(ab.getAllRanges())},toggleRange:function(ab){if(this.isAppliedToRange(ab)){this.undoToRange(ab)}else{this.applyToRange(ab)}},toggleSelection:function(ab){if(this.isAppliedToSelection(ab)){this.undoToSelection(ab)}else{this.applyToSelection(ab)}},getElementsWithClassIntersectingRange:function(ab){var ad=[];var ac=this;ab.getNodes([3],function(af){var ae=ac.getSelfOrAncestorWithClass(af);if(ae&&!F(ad,ae)){ad.push(ae)}});return ad},detach:function(){}};function L(ad,ac,ab){return new I(ad,ac,ab)}I.util={hasClass:Q,addClass:z,removeClass:s,getClass:m,hasSameClasses:r,hasAllClasses:y,replaceWithOwnChildren:M,elementsHaveSameNonClassAttributes:W,elementHasNonClassAttributes:X,splitNodeAt:R,isEditableElement:v,isEditingHost:g,isEditable:f};k.CssClassApplier=k.ClassApplier=I;k.createCssClassApplier=k.createClassApplier=L});return a},this);