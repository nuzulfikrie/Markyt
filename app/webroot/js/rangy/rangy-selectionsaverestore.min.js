(function(b,a){if(typeof define=="function"&&define.amd){define(["./rangy-core"],b)}else{if(typeof module!="undefined"&&typeof exports=="object"){module.exports=b(require("rangy"))}else{b(a.rangy)}}})(function(a){a.createModule("SaveRestore",["WrappedRange"],function(k,g){var j=k.dom;var h=j.removeNode;var d="\ufeff";function r(t,s){return(s||document).getElementById(t)}function e(u,s){var v="selectionBoundary_"+(+new Date())+"_"+(""+Math.random()).slice(2);var t;var x=j.getDocument(u.startContainer);var w=u.cloneRange();w.collapse(s);t=x.createElement("span");t.id=v;t.style.lineHeight="0";t.style.display="none";t.className="rangySelectionBoundary";t.appendChild(x.createTextNode(d));w.insertNode(t);return t}function o(w,u,v,s){var t=r(v,w);if(t){u[s?"setStartBefore":"setEndBefore"](t);h(t)}else{g.warn("Marker element has been removed. Cannot restore selection.")}}function f(t,s){return s.compareBoundaryPoints(t.START_TO_START,t)}function m(s,x){var u,t,v=k.DomRange.getRangeDocument(s),w=s.toString();if(s.collapsed){t=e(s,false);return{document:v,markerId:t.id,collapsed:true}}else{t=e(s,false);u=e(s,true);return{document:v,startMarkerId:u.id,endMarkerId:t.id,collapsed:false,backward:x,toString:function(){return"original text: '"+w+"', new text: '"+s.toString()+"'"}}}}function q(w,v){var x=w.document;if(typeof v=="undefined"){v=true}var u=k.createRange(x);if(w.collapsed){var t=r(w.markerId,x);if(t){t.style.display="inline";var s=t.previousSibling;if(s&&s.nodeType==3){h(t);u.collapseToPoint(s,s.length)}else{u.collapseBefore(t);h(t)}}else{g.warn("Marker element has been removed. Cannot restore selection.")}}else{o(x,u,w.startMarkerId,true);o(x,u,w.endMarkerId,false)}if(v){u.normalizeBoundaries()}return u}function c(t,y){var w=[],u,x;t=t.slice(0);t.sort(f);for(var v=0,s=t.length;v<s;++v){w[v]=m(t[v],y)}for(v=s-1;v>=0;--v){u=t[v];x=k.DomRange.getRangeDocument(u);if(u.collapsed){u.collapseAfter(r(w[v].markerId,x))}else{u.setEndBefore(r(w[v].endMarkerId,x));u.setStartAfter(r(w[v].startMarkerId,x))}}return w}function i(v){if(!k.isSelectionValid(v)){g.warn("Cannot save selection. This usually happens when the selection is collapsed and the selection document has lost focus.");return null}var u=k.getSelection(v);var s=u.getAllRanges();var w=(s.length==1&&u.isBackward());var t=c(s,w);if(w){u.setSingleRange(s[0],"backward")}else{u.setRanges(s)}return{win:v,rangeInfos:t,restored:false}}function p(v){var s=[];var t=v.length;for(var u=t-1;u>=0;u--){s[u]=q(v[u],true)}return s}function b(s,v){if(!s.restored){var w=s.rangeInfos;var x=k.getSelection(s.win);var t=p(w),u=w.length;if(u==1&&v&&k.features.selectionHasExtend&&w[0].backward){x.removeAllRanges();x.addRange(t[0],true)}else{x.setRanges(t)}s.restored=true}}function l(u,t){var s=r(t,u);if(s){h(s)}}function n(t){var w=t.rangeInfos;for(var v=0,s=w.length,u;v<s;++v){u=w[v];if(u.collapsed){l(t.doc,u.markerId)}else{l(t.doc,u.startMarkerId);l(t.doc,u.endMarkerId)}}}k.util.extend(k,{saveRange:m,restoreRange:q,saveRanges:c,restoreRanges:p,saveSelection:i,restoreSelection:b,removeMarkerElement:l,removeMarkers:n})});return a},this);